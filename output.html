<!doctype html><html lang="en"><head><title data-rh="true">Multiscope Authentication in oauth. Using entraID | Medium</title><meta data-rh="true" charset="utf-8"/><meta data-rh="true" name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1,maximum-scale=1"/><meta data-rh="true" name="theme-color" content="#000000"/><meta data-rh="true" name="twitter:app:name:iphone" content="Medium"/><meta data-rh="true" name="twitter:app:id:iphone" content="828256236"/><meta data-rh="true" property="al:ios:app_name" content="Medium"/><meta data-rh="true" property="al:ios:app_store_id" content="828256236"/><meta data-rh="true" property="al:android:package" content="com.medium.reader"/><meta data-rh="true" property="fb:app_id" content="542599432471018"/><meta data-rh="true" property="og:site_name" content="Medium"/><meta data-rh="true" property="og:type" content="article"/><meta data-rh="true" property="article:published_time" content="2024-01-14T23:54:40.242Z"/><meta data-rh="true" name="title" content="Multiscope Authentication in oauth. Using entraID | Medium"/><meta data-rh="true" property="og:title" content="Navigating the Complexity of Acquiring Multiple Resource Group Scopes in OAuth"/><meta data-rh="true" property="al:android:url" content="medium://p/74527886921c"/><meta data-rh="true" property="al:ios:url" content="medium://p/74527886921c"/><meta data-rh="true" property="al:android:app_name" content="Medium"/><meta data-rh="true" name="description" content="Using oauth2 to acquire multiple Ressource group Scopes."/><meta data-rh="true" property="og:description" content="Multi scope token authentication in Microsoft Entra ID"/><meta data-rh="true" property="og:url" content="https://medium.com/@fadop3/navigating-the-complexity-of-acquiring-multiple-resource-group-scopes-in-oauth-74527886921c"/><meta data-rh="true" property="al:web:url" content="https://medium.com/@fadop3/navigating-the-complexity-of-acquiring-multiple-resource-group-scopes-in-oauth-74527886921c"/><meta data-rh="true" property="og:image" content="https://miro.medium.com/v2/resize:fit:1024/1*ytetQ6n7dB1Sm8e_wbcPBw.png"/><meta data-rh="true" property="article:author" content="https://medium.com/@fadop3"/><meta data-rh="true" name="author" content="Fabian Peschke"/><meta data-rh="true" name="robots" content="index,follow,max-image-preview:large"/><meta data-rh="true" name="referrer" content="unsafe-url"/><meta data-rh="true" property="twitter:title" content="Navigating the Complexity of Acquiring Multiple Resource Group Scopes in OAuth"/><meta data-rh="true" name="twitter:site" content="@Medium"/><meta data-rh="true" name="twitter:app:url:iphone" content="medium://p/74527886921c"/><meta data-rh="true" property="twitter:description" content="Multi scope token authentication in Microsoft Entra ID"/><meta data-rh="true" name="twitter:image:src" content="https://miro.medium.com/v2/resize:fit:1024/1*ytetQ6n7dB1Sm8e_wbcPBw.png"/><meta data-rh="true" name="twitter:card" content="summary_large_image"/><meta data-rh="true" name="twitter:label1" content="Reading time"/><meta data-rh="true" name="twitter:data1" content="10 min read"/><meta data-rh="true" name="twitter:tile:template:testing" content="2"/><meta data-rh="true" name="twitter:tile:image" content="https://miro.medium.com/v2/resize:fit:1024/1*ytetQ6n7dB1Sm8e_wbcPBw.png"/><meta data-rh="true" name="twitter:tile:info1:icon" content="Person"/><meta data-rh="true" name="twitter:tile:info1:text" content="Fabian Peschke"/><meta data-rh="true" name="twitter:tile:info2:icon" content="Calendar"/><meta data-rh="true" name="twitter:tile:info2:text" content="Jan 14, 2024"/><meta data-rh="true" name="twitter:cta" content="Read on Medium"/><link data-rh="true" rel="icon" href="https://miro.medium.com/v2/1*m-R_BkNf1Qjr1YbyOIJY2w.png"/><link data-rh="true" rel="search" type="application/opensearchdescription+xml" title="Medium" href="/osd.xml"/><link data-rh="true" rel="apple-touch-icon" sizes="152x152" href="https://miro.medium.com/v2/resize:fill:152:152/1*sHhtYhaCe2Uc3IU0IgKwIQ.png"/><link data-rh="true" rel="apple-touch-icon" sizes="120x120" href="https://miro.medium.com/v2/resize:fill:120:120/1*sHhtYhaCe2Uc3IU0IgKwIQ.png"/><link data-rh="true" rel="apple-touch-icon" sizes="76x76" href="https://miro.medium.com/v2/resize:fill:76:76/1*sHhtYhaCe2Uc3IU0IgKwIQ.png"/><link data-rh="true" rel="apple-touch-icon" sizes="60x60" href="https://miro.medium.com/v2/resize:fill:60:60/1*sHhtYhaCe2Uc3IU0IgKwIQ.png"/><link data-rh="true" rel="mask-icon" href="https://cdn-static-1.medium.com/_/fp/icons/Medium-Avatar-500x500.svg" color="#171717"/><link data-rh="true" rel="preconnect" href="https://glyph.medium.com" crossOrigin=""/><link data-rh="true" id="glyph_preload_link" rel="preload" as="style" type="text/css" href="https://glyph.medium.com/css/unbound.css"/><link data-rh="true" id="glyph_link" rel="stylesheet" type="text/css" href="https://glyph.medium.com/css/unbound.css"/><link data-rh="true" rel="author" href="https://medium.com/@fadop3"/><link data-rh="true" rel="canonical" href="https://medium.com/@fadop3/navigating-the-complexity-of-acquiring-multiple-resource-group-scopes-in-oauth-74527886921c"/><link data-rh="true" rel="alternate" href="android-app://com.medium.reader/https/medium.com/p/74527886921c"/><script data-rh="true" type="application/ld+json">{"@context":"http:\u002F\u002Fschema.org","@type":"NewsArticle","image":["https:\u002F\u002Fmiro.medium.com\u002Fv2\u002Fresize:fit:1200\u002F1*ytetQ6n7dB1Sm8e_wbcPBw.png"],"url":"https:\u002F\u002Fmedium.com\u002F@fadop3\u002Fnavigating-the-complexity-of-acquiring-multiple-resource-group-scopes-in-oauth-74527886921c","dateCreated":"2024-01-14T23:54:40.242Z","datePublished":"2024-01-14T23:54:40.242Z","dateModified":"2024-01-15T00:28:52.943Z","headline":"Multiscope Authentication in oauth. Using entraID | Medium","name":"Multiscope Authentication in oauth. Using entraID | Medium","description":"Using oauth2 to acquire multiple Ressource group Scopes.","identifier":"74527886921c","author":{"@type":"Person","name":"Fabian Peschke","url":"https:\u002F\u002Fmedium.com\u002F@fadop3"},"creator":["Fabian Peschke"],"publisher":{"@type":"Organization","name":"Medium","url":"https:\u002F\u002Fmedium.com\u002F","logo":{"@type":"ImageObject","width":308,"height":60,"url":"https:\u002F\u002Fmiro.medium.com\u002Fv2\u002Fresize:fit:616\u002F1*OMF3fSqH8t4xBJ9-6oZDZw.png"}},"mainEntityOfPage":"https:\u002F\u002Fmedium.com\u002F@fadop3\u002Fnavigating-the-complexity-of-acquiring-multiple-resource-group-scopes-in-oauth-74527886921c"}</script><style type="text/css" data-fela-rehydration="545" data-fela-type="STATIC">html{box-sizing:border-box;-webkit-text-size-adjust:100%}*, *:before, *:after{box-sizing:inherit}body{margin:0;padding:0;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;color:rgba(0,0,0,0.8);position:relative;min-height:100vh}h1, h2, h3, h4, h5, h6, dl, dd, ol, ul, menu, figure, blockquote, p, pre, form{margin:0}menu, ol, ul{padding:0;list-style:none;list-style-image:none}main{display:block}a{color:inherit;text-decoration:none}a, button, input{-webkit-tap-highlight-color:transparent}img, svg{vertical-align:middle}button{background:transparent;overflow:visible}button, input, optgroup, select, textarea{margin:0}:root{--reach-tabs:1;--reach-menu-button:1}#speechify-root{font-family:Sohne, sans-serif}div[data-popper-reference-hidden="true"]{visibility:hidden;pointer-events:none}
/*XCode style (c) Angel Garcia <angelgarcia.mail@gmail.com>*/.hljs {background: #fff;color: black;
}/* Gray DOCTYPE selectors like WebKit */
.xml .hljs-meta {color: #c0c0c0;
}.hljs-comment,
.hljs-quote {color: #007400;
}.hljs-tag,
.hljs-attribute,
.hljs-keyword,
.hljs-selector-tag,
.hljs-literal,
.hljs-name {color: #aa0d91;
}.hljs-variable,
.hljs-template-variable {color: #3F6E74;
}.hljs-code,
.hljs-string,
.hljs-meta .hljs-string {color: #c41a16;
}.hljs-regexp,
.hljs-link {color: #0E0EFF;
}.hljs-title,
.hljs-symbol,
.hljs-bullet,
.hljs-number {color: #1c00cf;
}.hljs-section,
.hljs-meta {color: #643820;
}.hljs-title.class_,
.hljs-class .hljs-title,
.hljs-type,
.hljs-built_in,
.hljs-params {color: #5c2699;
}.hljs-attr {color: #836C28;
}.hljs-subst {color: #000;
}.hljs-formula {background-color: #eee;font-style: italic;
}.hljs-addition {background-color: #baeeba;
}.hljs-deletion {background-color: #ffc8bd;
}.hljs-selector-id,
.hljs-selector-class {color: #9b703f;
}.hljs-doctag,
.hljs-strong {font-weight: bold;
}.hljs-emphasis {font-style: italic;
}
</style><style type="text/css" data-fela-rehydration="545" data-fela-type="KEYFRAME">@-webkit-keyframes k1{0%{opacity:0.8}50%{opacity:0.5}100%{opacity:0.8}}@-moz-keyframes k1{0%{opacity:0.8}50%{opacity:0.5}100%{opacity:0.8}}@keyframes k1{0%{opacity:0.8}50%{opacity:0.5}100%{opacity:0.8}}@-webkit-keyframes k2{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}@-moz-keyframes k2{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}@keyframes k2{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}</style><style type="text/css" data-fela-rehydration="545" data-fela-type="RULE">.a{font-family:medium-content-sans-serif-font, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif}.b{font-weight:400}.c{background-color:rgba(255, 255, 255, 1)}.l{display:block}.m{position:sticky}.n{top:0}.o{z-index:500}.p{padding:0 24px}.q{align-items:center}.r{border-bottom:solid 1px #F2F2F2}.y{height:41px}.z{line-height:20px}.ab{display:flex}.ac{height:57px}.ae{flex:1 0 auto}.af{color:inherit}.ag{fill:inherit}.ah{font-size:inherit}.ai{border:inherit}.aj{font-family:inherit}.ak{letter-spacing:inherit}.al{font-weight:inherit}.am{padding:0}.an{margin:0}.ao{cursor:pointer}.ap:disabled{cursor:not-allowed}.aq:disabled{color:#6B6B6B}.ar:disabled{fill:#6B6B6B}.au{fill:rgba(0, 0, 0, 1)}.av{height:22px}.aw{margin-left:16px}.ax{border:none}.ay{border-radius:20px}.az{width:240px}.ba{background:#F9F9F9}.bb path{fill:#6B6B6B}.bd{outline:none}.be{font-family:sohne, "Helvetica Neue", Helvetica, Arial, sans-serif}.bf{font-size:14px}.bg{width:100%}.bh{padding:10px 20px 10px 0}.bi{background-color:transparent}.bj{color:#242424}.bk::placeholder{color:#6B6B6B}.bl{display:inline-block}.bm{margin-left:12px}.bn{margin-right:12px}.bo{border-radius:4px}.bp{margin-left:24px}.bq{height:24px}.bw{background-color:#F9F9F9}.bx{border-radius:50%}.by{height:32px}.bz{width:32px}.ca{justify-content:center}.cg{max-width:680px}.ch{min-width:0}.ci{animation:k1 1.2s ease-in-out infinite}.cj{height:100vh}.ck{margin-bottom:16px}.cl{margin-top:48px}.cm{align-items:flex-start}.cn{flex-direction:column}.co{justify-content:space-between}.cp{margin-bottom:24px}.cv{width:80%}.cw{background-color:#F2F2F2}.dc{height:44px}.dd{width:44px}.de{margin:auto 0}.df{margin-bottom:4px}.dg{height:16px}.dh{width:120px}.di{width:80px}.do{margin-bottom:8px}.dp{width:96%}.dq{width:98%}.dr{width:81%}.ds{margin-left:8px}.dt{color:#6B6B6B}.du{font-size:13px}.dv{height:100%}.el{color:#FFFFFF}.em{fill:#FFFFFF}.eo{background:#1A8917}.ep{border-color:#1A8917}.et:disabled{cursor:inherit !important}.eu:disabled{opacity:0.3}.ev:disabled:hover{background:#1A8917}.ew:disabled:hover{border-color:#1A8917}.ex{border-radius:99em}.ey{border-width:1px}.ez{border-style:solid}.fa{box-sizing:border-box}.fb{text-decoration:none}.fc{text-align:center}.ff{margin-right:32px}.fg{position:relative}.fh{fill:#6B6B6B}.fk{background:transparent}.fl svg{margin-left:4px}.fm svg{fill:#6B6B6B}.fo{box-shadow:inset 0 0 0 1px rgba(0, 0, 0, 0.05)}.fp{position:absolute}.fw{margin:0 24px}.ga{background:rgba(255, 255, 255, 1)}.gb{border:1px solid #F2F2F2}.gc{box-shadow:0 1px 4px #F2F2F2}.gd{max-height:100vh}.ge{overflow-y:auto}.gf{left:0}.gg{top:calc(100vh + 100px)}.gh{bottom:calc(100vh + 100px)}.gi{width:10px}.gj{pointer-events:none}.gk{word-break:break-word}.gl{word-wrap:break-word}.gm:after{display:block}.gn:after{content:""}.go:after{clear:both}.gp{line-height:1.23}.gq{letter-spacing:0}.gr{font-style:normal}.gs{font-weight:700}.hn{margin-bottom:-0.27em}.ho{line-height:1.394}.ie{@media all and (max-width: 551.98px):8px}.if{@media all and (min-width: 552px) and (max-width: 727.98px):8px}.ig{@media all and (min-width: 728px) and (max-width: 903.98px):16px}.ih{@media all and (min-width: 904px) and (max-width: 1079.98px):16px}.ii{@media all and (min-width: 1080px):16px}.io{align-items:baseline}.ip{width:48px}.iq{height:48px}.ir{border:2px solid rgba(255, 255, 255, 1)}.is{z-index:0}.it{box-shadow:none}.iu{border:1px solid rgba(0, 0, 0, 0.05)}.iv{margin-bottom:2px}.iw{flex-wrap:nowrap}.ix{font-size:16px}.iy{line-height:24px}.ja{margin:0 8px}.jb{display:inline}.jc{color:#1A8917}.jd{fill:#1A8917}.jg{flex:0 0 auto}.jj{flex-wrap:wrap}.jk{padding-left:8px}.jl{padding-right:8px}.km> *{flex-shrink:0}.kn{overflow-x:scroll}.ko::-webkit-scrollbar{display:none}.kp{scrollbar-width:none}.kq{-ms-overflow-style:none}.kr{width:74px}.ks{flex-direction:row}.kt{margin-right:4px}.kw{-webkit-user-select:none}.kx{border:0}.ky{cursor:progress}.kz{fill:rgba(117, 117, 117, 1)}.lc{opacity:0.25}.ld{outline:0}.le{user-select:none}.lf> svg{pointer-events:none}.lo{opacity:1}.lp{padding:4px 0}.ls{margin-top:0px}.lt{width:16px}.lu{display:inline-flex}.ma{max-width:100%}.mb{padding:8px 2px}.mc svg{color:#6B6B6B}.mt{margin-left:auto}.mu{margin-right:auto}.mv{max-width:1024px}.nb{clear:both}.nd{cursor:zoom-in}.ne{z-index:auto}.ng{height:auto}.nh{margin-top:10px}.ni{max-width:728px}.nl{line-height:1.18}.nm{letter-spacing:-0.022em}.nn{font-weight:600}.og{margin-bottom:-0.31em}.oh{line-height:1.58}.oi{letter-spacing:-0.004em}.oj{font-family:source-serif-pro, Georgia, Cambria, "Times New Roman", Times, serif}.oz{margin-bottom:-0.46em}.pa{margin-top:32px}.pb{margin-bottom:14px}.pc{padding-top:24px}.pd{padding-bottom:10px}.pe{background-color:#000000}.pf{height:3px}.pg{width:3px}.ph{margin-right:20px}.pi{line-height:1.12}.pz{margin-bottom:-0.28em}.qf{list-style-type:decimal}.qg{margin-left:30px}.qh{padding-left:0px}.qs{list-style-type:disc}.qt{text-decoration:underline}.qu{max-width:1614px}.qv{max-width:1374px}.qw{overflow-x:auto}.qx{font-family:source-code-pro, Menlo, Monaco, "Courier New", Courier, monospace}.qy{padding:32px}.qz{border:1px solid #E5E5E5}.ra{line-height:1.4}.rb{margin-top:-0.2em}.rc{margin-bottom:-0.2em}.rd{white-space:pre}.re{min-width:fit-content}.rf{max-width:1248px}.rg{max-width:847px}.rh{padding:2px 4px}.ri{font-size:75%}.rj> strong{font-family:inherit}.rk{max-width:774px}.rl{margin-bottom:26px}.rm{margin-top:6px}.rn{margin-top:8px}.ro{margin-right:8px}.rp{padding:8px 16px}.rq{border-radius:100px}.rr{transition:background 300ms ease}.rt{white-space:nowrap}.ru{border-top:none}.sa{height:52px}.sb{max-height:52px}.sc{box-sizing:content-box}.sd{position:static}.se{z-index:1}.sg{max-width:155px}.sr{align-items:flex-end}.ss{width:76px}.st{height:76px}.su{border:2px solid #F9F9F9}.sv{height:72px}.sw{width:72px}.sx{width:auto}.sy{stroke:#F2F2F2}.sz{height:36px}.ta{width:36px}.tb{color:#F2F2F2}.tc{fill:#F2F2F2}.td{background:#F2F2F2}.te{border-color:#F2F2F2}.tk{font-weight:500}.tl{font-size:24px}.tm{line-height:30px}.tn{letter-spacing:-0.016em}.to{margin-top:16px}.tp{height:0px}.tq{border-bottom:solid 1px #E5E5E5}.tw{margin-top:72px}.tx{padding:24px 0}.ty{margin-bottom:0px}.tz{margin-right:16px}.as:hover:not(:disabled){color:rgba(25, 25, 25, 1)}.at:hover:not(:disabled){fill:rgba(25, 25, 25, 1)}.eq:hover{background:#156D12}.er:hover{border-color:#156D12}.es:hover{cursor:pointer}.fi:hover{color:#242424}.fj:hover{fill:#242424}.fn:hover svg{fill:#242424}.fq:hover{background-color:rgba(0, 0, 0, 0.1)}.iz:hover{text-decoration:underline}.je:hover:not(:disabled){color:#156D12}.jf:hover:not(:disabled){fill:#156D12}.lb:hover{fill:rgba(117, 117, 117, 1)}.lq:hover{fill:#000000}.lr:hover p{color:#000000}.md:hover svg{color:#000000}.rs:hover{background-color:#F2F2F2}.tf:hover{background:#F2F2F2}.tg:hover{border-color:#F2F2F2}.th:hover{cursor:wait}.ti:hover{color:#F2F2F2}.tj:hover{fill:#F2F2F2}.bc:focus-within path{fill:#242424}.la:focus{fill:rgba(117, 117, 117, 1)}.me:focus svg{color:#000000}.nf:focus{transform:scale(1.01)}.lg:active{border-style:none}</style><style type="text/css" data-fela-rehydration="545" data-fela-type="RULE" media="all and (min-width: 1080px)">.d{display:none}.bv{width:64px}.cf{margin:0 64px}.cu{height:48px}.db{margin-bottom:52px}.dn{margin-bottom:48px}.ee{font-size:14px}.ef{line-height:20px}.ek{padding:5px 12px}.fe{display:flex}.fv{margin-bottom:68px}.fz{max-width:680px}.hj{font-size:42px}.hk{margin-top:1.19em}.hl{line-height:52px}.hm{letter-spacing:-0.011em}.ib{font-size:22px}.ic{margin-top:0.92em}.id{line-height:28px}.in{align-items:center}.jy{border-top:solid 1px #F2F2F2}.jz{border-bottom:solid 1px #F2F2F2}.ka{margin:32px 0 0}.kb{padding:3px 8px}.kk> *{margin-right:24px}.kl> :last-child{margin-right:0}.ln{margin-top:0px}.lz{margin:0}.na{margin-top:56px}.oc{font-size:20px}.od{margin-top:1.72em}.oe{line-height:24px}.of{letter-spacing:0}.ow{margin-top:0.94em}.ox{line-height:32px}.oy{letter-spacing:-0.003em}.pv{font-size:24px}.pw{margin-top:1.25em}.px{line-height:30px}.py{letter-spacing:-0.016em}.qe{margin-top:2.14em}.qm{margin-top:1.14em}.qr{margin-top:1.95em}.rz{margin-bottom:88px}.sl{display:inline-block}.sq{padding-top:72px}.tv{margin-top:40px}</style><style type="text/css" data-fela-rehydration="545" data-fela-type="RULE" media="all and (max-width: 1079.98px)">.e{display:none}.lm{margin-top:0px}.nj{margin-left:auto}.nk{text-align:center}.sk{display:inline-block}</style><style type="text/css" data-fela-rehydration="545" data-fela-type="RULE" media="all and (max-width: 903.98px)">.f{display:none}.ll{margin-top:0px}.sj{display:inline-block}</style><style type="text/css" data-fela-rehydration="545" data-fela-type="RULE" media="all and (max-width: 727.98px)">.g{display:none}.lj{margin-top:0px}.lk{margin-right:0px}.si{display:inline-block}</style><style type="text/css" data-fela-rehydration="545" data-fela-type="RULE" media="all and (max-width: 551.98px)">.h{display:none}.s{display:flex}.t{justify-content:space-between}.br{width:24px}.cb{margin:0 24px}.cq{height:40px}.cx{margin-bottom:44px}.dj{margin-bottom:32px}.dw{font-size:13px}.dx{line-height:20px}.eg{padding:0px 8px 1px}.fr{margin-bottom:4px}.gt{font-size:32px}.gu{margin-top:1.01em}.gv{line-height:38px}.gw{letter-spacing:-0.014em}.hp{font-size:18px}.hq{margin-top:0.79em}.hr{line-height:24px}.ij{align-items:flex-start}.jh{flex-direction:column}.jm{margin:24px -24px 0}.jn{padding:0}.kc> *{margin-right:8px}.kd> :last-child{margin-right:24px}.ku{margin-left:0px}.lh{margin-top:0px}.li{margin-right:0px}.lv{margin:0}.mf{border:1px solid #F2F2F2}.mg{border-radius:99em}.mh{padding:0px 16px 0px 12px}.mi{height:38px}.mj{align-items:center}.ml svg{margin-right:8px}.mw{margin-top:40px}.no{font-size:16px}.np{margin-top:1.23em}.nq{letter-spacing:0}.ok{margin-top:0.67em}.ol{line-height:28px}.om{letter-spacing:-0.003em}.pj{font-size:20px}.pk{margin-top:0.93em}.qa{margin-top:1.56em}.qi{margin-top:1.34em}.qn{margin-top:1.2em}.rv{margin-bottom:80px}.sh{display:inline-block}.sm{padding-top:48px}.tr{margin-top:32px}.mk:hover{border-color:#E5E5E5}</style><style type="text/css" data-fela-rehydration="545" data-fela-type="RULE" media="all and (min-width: 904px) and (max-width: 1079.98px)">.i{display:none}.bu{width:64px}.ce{margin:0 64px}.ct{height:48px}.da{margin-bottom:52px}.dm{margin-bottom:48px}.ec{font-size:14px}.ed{line-height:20px}.ej{padding:5px 12px}.fd{display:flex}.fu{margin-bottom:68px}.fy{max-width:680px}.hf{font-size:42px}.hg{margin-top:1.19em}.hh{line-height:52px}.hi{letter-spacing:-0.011em}.hy{font-size:22px}.hz{margin-top:0.92em}.ia{line-height:28px}.im{align-items:center}.ju{border-top:solid 1px #F2F2F2}.jv{border-bottom:solid 1px #F2F2F2}.jw{margin:32px 0 0}.jx{padding:3px 8px}.ki> *{margin-right:24px}.kj> :last-child{margin-right:0}.ly{margin:0}.mz{margin-top:56px}.ny{font-size:20px}.nz{margin-top:1.72em}.oa{line-height:24px}.ob{letter-spacing:0}.ot{margin-top:0.94em}.ou{line-height:32px}.ov{letter-spacing:-0.003em}.pr{font-size:24px}.ps{margin-top:1.25em}.pt{line-height:30px}.pu{letter-spacing:-0.016em}.qd{margin-top:2.14em}.ql{margin-top:1.14em}.qq{margin-top:1.95em}.ry{margin-bottom:88px}.sp{padding-top:72px}.tu{margin-top:40px}</style><style type="text/css" data-fela-rehydration="545" data-fela-type="RULE" media="all and (min-width: 728px) and (max-width: 903.98px)">.j{display:none}.w{display:flex}.x{justify-content:space-between}.bt{width:64px}.cd{margin:0 48px}.cs{height:48px}.cz{margin-bottom:52px}.dl{margin-bottom:48px}.ea{font-size:13px}.eb{line-height:20px}.ei{padding:0px 8px 1px}.ft{margin-bottom:68px}.fx{max-width:680px}.hb{font-size:42px}.hc{margin-top:1.19em}.hd{line-height:52px}.he{letter-spacing:-0.011em}.hv{font-size:22px}.hw{margin-top:0.92em}.hx{line-height:28px}.il{align-items:center}.jq{border-top:solid 1px #F2F2F2}.jr{border-bottom:solid 1px #F2F2F2}.js{margin:32px 0 0}.jt{padding:3px 8px}.kg> *{margin-right:24px}.kh> :last-child{margin-right:0}.lx{margin:0}.my{margin-top:56px}.nu{font-size:20px}.nv{margin-top:1.72em}.nw{line-height:24px}.nx{letter-spacing:0}.oq{margin-top:0.94em}.or{line-height:32px}.os{letter-spacing:-0.003em}.pn{font-size:24px}.po{margin-top:1.25em}.pp{line-height:30px}.pq{letter-spacing:-0.016em}.qc{margin-top:2.14em}.qk{margin-top:1.14em}.qp{margin-top:1.95em}.rx{margin-bottom:88px}.so{padding-top:72px}.tt{margin-top:40px}</style><style type="text/css" data-fela-rehydration="545" data-fela-type="RULE" media="all and (min-width: 552px) and (max-width: 727.98px)">.k{display:none}.u{display:flex}.v{justify-content:space-between}.bs{width:24px}.cc{margin:0 24px}.cr{height:40px}.cy{margin-bottom:44px}.dk{margin-bottom:32px}.dy{font-size:13px}.dz{line-height:20px}.eh{padding:0px 8px 1px}.fs{margin-bottom:4px}.gx{font-size:32px}.gy{margin-top:1.01em}.gz{line-height:38px}.ha{letter-spacing:-0.014em}.hs{font-size:18px}.ht{margin-top:0.79em}.hu{line-height:24px}.ik{align-items:flex-start}.ji{flex-direction:column}.jo{margin:24px 0 0}.jp{padding:0}.ke> *{margin-right:8px}.kf> :last-child{margin-right:8px}.kv{margin-left:0px}.lw{margin:0}.mm{border:1px solid #F2F2F2}.mn{border-radius:99em}.mo{padding:0px 16px 0px 12px}.mp{height:38px}.mq{align-items:center}.ms svg{margin-right:8px}.mx{margin-top:40px}.nr{font-size:16px}.ns{margin-top:1.23em}.nt{letter-spacing:0}.on{margin-top:0.67em}.oo{line-height:28px}.op{letter-spacing:-0.003em}.pl{font-size:20px}.pm{margin-top:0.93em}.qb{margin-top:1.56em}.qj{margin-top:1.34em}.qo{margin-top:1.2em}.rw{margin-bottom:80px}.sn{padding-top:48px}.ts{margin-top:32px}.mr:hover{border-color:#E5E5E5}</style><style type="text/css" data-fela-rehydration="545" data-fela-type="RULE" media="print">.sf{display:none}</style><style type="text/css" data-fela-rehydration="545" data-fela-type="RULE" media="(prefers-reduced-motion: no-preference)">.nc{transition:transform 300ms cubic-bezier(0.2, 0, 0.2, 1)}</style></head><body><div id="root"><div class="a b c"><div class="d e f g h i j k"></div><script>document.domain = document.domain;</script><div class="l c"><div class="l m n o c"><div class="p q r s t u v w x i d y z"><a class="dt ag du be ak b am an ao ap aq ar as at s u w i d q dv z" href="https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F74527886921c&amp;%7Efeature=LoOpenInAppButton&amp;%7Echannel=ShowPostUnderUser&amp;source=---two_column_layout_nav----------------------------------" rel="noopener follow">Open in app<svg width="10" height="10" viewBox="0 0 10 10" fill="none" class="ds"><path d="M.98 8.48a.37.37 0 1 0 .54.54l-.54-.54zm7.77-7.23h.38c0-.2-.17-.38-.38-.38v.38zM8.37 6.5a.37.37 0 1 0 .76 0h-.76zM3.5.87a.37.37 0 1 0 0 .76V.88zM1.52 9.03l7.5-7.5-.54-.54-7.5 7.5.54.54zm6.86-7.77V6.5h.74V1.25h-.74zm-4.88.38h5.25V.88H3.5v.74z" fill="currentColor"></path></svg></a><div class="ab q"><p class="be b dw dx dy dz ea eb ec ed ee ef dt"><span><button class="be b dw dx eg dy dz eh ea eb ei ec ed ej ee ef ek el em eo ep eq er es et eu ev ew ex ey ez fa bl fb fc" data-testid="headerSignUpButton">Sign up</button></span></p><div class="aw l"><p class="be b dw dx dy dz ea eb ec ed ee ef dt"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="headerSignInButton" rel="noopener follow" href="/m/signin?operation=login&amp;redirect=https%3A%2F%2Fmedium.com%2F%40fadop3%2Fnavigating-the-complexity-of-acquiring-multiple-resource-group-scopes-in-oauth-74527886921c&amp;source=post_page---two_column_layout_nav-----------------------global_nav-----------">Sign in</a></span></p></div></div></div><div class="p q r ab ac"><div class="ab q ae"><a class="af ag ah ai aj ak al am an ao ap aq ar as at ab" aria-label="Homepage" data-testid="headerMediumLogo" rel="noopener follow" href="/?source=---two_column_layout_nav----------------------------------"><svg viewBox="0 0 3940 610" class="au av"><path d="M594.79 308.2c0 163.76-131.85 296.52-294.5 296.52S5.8 472 5.8 308.2 137.65 11.69 300.29 11.69s294.5 132.75 294.5 296.51M917.86 308.2c0 154.16-65.93 279.12-147.25 279.12s-147.25-125-147.25-279.12S689.29 29.08 770.61 29.08s147.25 125 147.25 279.12M1050 308.2c0 138.12-23.19 250.08-51.79 250.08s-51.79-112-51.79-250.08 23.19-250.08 51.8-250.08S1050 170.09 1050 308.2M1862.77 37.4l.82-.18v-6.35h-167.48l-155.51 365.5-155.51-365.5h-180.48v6.35l.81.18c30.57 6.9 46.09 17.19 46.09 54.3v434.45c0 37.11-15.58 47.4-46.15 54.3l-.81.18V587H1327v-6.35l-.81-.18c-30.57-6.9-46.09-17.19-46.09-54.3V116.9L1479.87 587h11.33l205.59-483.21V536.9c-2.62 29.31-18 38.36-45.68 44.61l-.82.19v6.3h213.3v-6.3l-.82-.19c-27.71-6.25-43.46-15.3-46.08-44.61l-.14-445.2h.14c0-37.11 15.52-47.4 46.08-54.3m97.43 287.8c3.49-78.06 31.52-134.4 78.56-135.37 14.51.24 26.68 5 36.14 14.16 20.1 19.51 29.55 60.28 28.09 121.21zm-2.11 22h250v-1.05c-.71-59.69-18-106.12-51.34-138-28.82-27.55-71.49-42.71-116.31-42.71h-1c-23.26 0-51.79 5.64-72.09 15.86-23.11 10.7-43.49 26.7-60.45 47.7-27.3 33.83-43.84 79.55-47.86 130.93-.13 1.54-.24 3.08-.35 4.62s-.18 2.92-.25 4.39a332.64 332.64 0 0 0-.36 21.69C1860.79 507 1923.65 600 2035.3 600c98 0 155.07-71.64 169.3-167.8l-7.19-2.53c-25 51.68-69.9 83-121 79.18-69.76-5.22-123.2-75.95-118.35-161.63m532.69 157.68c-8.2 19.45-25.31 30.15-48.24 30.15s-43.89-15.74-58.78-44.34c-16-30.7-24.42-74.1-24.42-125.51 0-107 33.28-176.21 84.79-176.21 21.57 0 38.55 10.7 46.65 29.37zm165.84 76.28c-30.57-7.23-46.09-18-46.09-57V5.28L2424.77 60v6.7l1.14-.09c25.62-2.07 43 1.47 53.09 10.79 7.9 7.3 11.75 18.5 11.75 34.26v71.14c-18.31-11.69-40.09-17.38-66.52-17.38-53.6 0-102.59 22.57-137.92 63.56-36.83 42.72-56.3 101.1-56.3 168.81C2230 518.72 2289.53 600 2378.13 600c51.83 0 93.53-28.4 112.62-76.3V588h166.65v-6.66zm159.29-505.33c0-37.76-28.47-66.24-66.24-66.24-37.59 0-67 29.1-67 66.24s29.44 66.24 67 66.24c37.77 0 66.24-28.48 66.24-66.24m43.84 505.33c-30.57-7.23-46.09-18-46.09-57h-.13V166.65l-166.66 47.85v6.5l1 .09c36.06 3.21 45.93 15.63 45.93 57.77V588h166.8v-6.66zm427.05 0c-30.57-7.23-46.09-18-46.09-57V166.65L3082 212.92v6.52l.94.1c29.48 3.1 38 16.23 38 58.56v226c-9.83 19.45-28.27 31-50.61 31.78-36.23 0-56.18-24.47-56.18-68.9V166.66l-166.66 47.85V221l1 .09c36.06 3.2 45.94 15.62 45.94 57.77v191.27a214.48 214.48 0 0 0 3.47 39.82l3 13.05c14.11 50.56 51.08 77 109 77 49.06 0 92.06-30.37 111-77.89v66h166.66v-6.66zM3934.2 588v-6.67l-.81-.19c-33.17-7.65-46.09-22.07-46.09-51.43v-243.2c0-75.83-42.59-121.09-113.93-121.09-52 0-95.85 30.05-112.73 76.86-13.41-49.6-52-76.86-109.06-76.86-50.12 0-89.4 26.45-106.25 71.13v-69.87l-166.66 45.89v6.54l1 .09c35.63 3.16 45.93 15.94 45.93 57V588h155.5v-6.66l-.82-.2c-26.46-6.22-35-17.56-35-46.66V255.72c7-16.35 21.11-35.72 49-35.72 34.64 0 52.2 24 52.2 71.28V588h155.54v-6.66l-.82-.2c-26.46-6.22-35-17.56-35-46.66v-248a160.45 160.45 0 0 0-2.2-27.68c7.42-17.77 22.34-38.8 51.37-38.8 35.13 0 52.2 23.31 52.2 71.28V588z"></path></svg></a><div class="aw h"><div class="ab ax ay az ba q bb bc"><div class="bl" aria-hidden="false" aria-describedby="searchResults" aria-labelledby="searchResults"></div><div class="bm bn ab"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.1 11.06a6.95 6.95 0 1 1 13.9 0 6.95 6.95 0 0 1-13.9 0zm6.94-8.05a8.05 8.05 0 1 0 5.13 14.26l3.75 3.75a.56.56 0 1 0 .8-.79l-3.74-3.73A8.05 8.05 0 0 0 11.04 3v.01z" fill="currentColor"></path></svg></div><input role="combobox" aria-controls="searchResults" aria-expanded="false" aria-label="search" data-testid="headerSearchInput" tabindex="0" class="ax bd be bf z bg bh bi bj bk" placeholder="Search" value=""/></div></div></div><div class="h k w fd fe"><div class="ff ab"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="headerWriteButton" rel="noopener follow" href="/m/signin?operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2Fnew-story&amp;source=---two_column_layout_nav-----------------------new_post_topnav-----------"><div class="be b bf z dt fg fh ab q fi fj"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" aria-label="Write"><path d="M14 4a.5.5 0 0 0 0-1v1zm7 6a.5.5 0 0 0-1 0h1zm-7-7H4v1h10V3zM3 4v16h1V4H3zm1 17h16v-1H4v1zm17-1V10h-1v10h1zm-1 1a1 1 0 0 0 1-1h-1v1zM3 20a1 1 0 0 0 1 1v-1H3zM4 3a1 1 0 0 0-1 1h1V3z" fill="currentColor"></path><path d="M17.5 4.5l-8.46 8.46a.25.25 0 0 0-.06.1l-.82 2.47c-.07.2.12.38.31.31l2.47-.82a.25.25 0 0 0 .1-.06L19.5 6.5m-2-2l2.32-2.32c.1-.1.26-.1.36 0l1.64 1.64c.1.1.1.26 0 .36L19.5 6.5m-2-2l2 2" stroke="currentColor"></path></svg><div class="ds l">Write</div></div></a></span></div></div><div class="k j i d"><div class="ff ab"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="headerSearchButton" rel="noopener follow" href="/search?source=---two_column_layout_nav----------------------------------"><div class="be b bf z dt fg fh ab q fi fj"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" aria-label="Search"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.1 11.06a6.95 6.95 0 1 1 13.9 0 6.95 6.95 0 0 1-13.9 0zm6.94-8.05a8.05 8.05 0 1 0 5.13 14.26l3.75 3.75a.56.56 0 1 0 .8-.79l-3.74-3.73A8.05 8.05 0 0 0 11.04 3v.01z" fill="currentColor"></path></svg></div></a></div></div><div class="ff h k j"><div class="ab q"><p class="be b dw dx dy dz ea eb ec ed ee ef dt"><span><button class="be b dw dx eg dy dz eh ea eb ei ec ed ej ee ef ek el em eo ep eq er es et eu ev ew ex ey ez fa bl fb fc" data-testid="headerSignUpButton">Sign up</button></span></p><div class="aw l"><p class="be b dw dx dy dz ea eb ec ed ee ef dt"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="headerSignInButton" rel="noopener follow" href="/m/signin?operation=login&amp;redirect=https%3A%2F%2Fmedium.com%2F%40fadop3%2Fnavigating-the-complexity-of-acquiring-multiple-resource-group-scopes-in-oauth-74527886921c&amp;source=post_page---two_column_layout_nav-----------------------global_nav-----------">Sign in</a></span></p></div></div></div><div class="l" aria-hidden="false"><button class="ax fk am ab q ao fl fm fn" aria-label="user options menu" data-testid="headerUserIcon"><div class="l fg"><img alt="" class="l fa bx by bz cw" src="https://miro.medium.com/v2/resize:fill:64:64/1*dmbNkD5D-u45r44go_cf0g.png" width="32" height="32" loading="lazy" role="presentation"/><div class="fo bx l by bz fp n ax fq"></div></div></button></div></div></div><div class="l"><div class="fr fs ft fu fv l"><div class="ab ca"><div class="ch bg fw fx fy fz"></div></div><article><div class="l"><div class="l"><span class="l"></span><section><div><div class="fp gf gg gh gi gj"></div><div class="gk gl gm gn go"><div class="ab ca"><div class="ch bg fw fx fy fz"><div><h1 id="5313" class="pw-post-title gp gq gr be gs gt gu gv gw gx gy gz ha hb hc hd he hf hg hh hi hj hk hl hm hn bj" data-testid="storyTitle">Navigating the Complexity of Acquiring Multiple Resource Group Scopes in OAuth</h1></div><div><h2 id="e51a" class="pw-subtitle-paragraph ho gq gr be b hp hq hr hs ht hu hv hw hx hy hz ia ib ic id cp dt">Multi scope token authentication in Microsoft Entra ID</h2><div class="ie if ig ih ii"><div class="speechify-ignore ab co"><div class="speechify-ignore bg l"><div class="ij ik il im in ab"><div><div class="ab io"><a rel="noopener follow" href="/@fadop3?source=post_page-----74527886921c--------------------------------"><div><div class="bl" aria-hidden="false"><div class="l ip iq bx ir is"><div class="l fg"><img alt="Fabian Peschke" class="l fa bx dc dd cw" src="https://miro.medium.com/v2/resize:fill:88:88/1*KlSOTO9tp09aM_xvVkIJDQ@2x.jpeg" width="44" height="44" loading="lazy" data-testid="authorPhoto"/><div class="it bx l dc dd fp n iu fq"></div></div></div></div></div></a></div></div><div class="bm bg l"><div class="ab"><div style="flex:1"><span class="be b bf z bj"><div class="iv ab q"><div class="ab q iw"><div class="ab q"><div><div class="bl" aria-hidden="false"><p class="be b ix iy bj"><a class="af ag ah ai aj ak al am an ao ap aq ar iz" data-testid="authorName" rel="noopener follow" href="/@fadop3?source=post_page-----74527886921c--------------------------------">Fabian Peschke</a></p></div></div></div><span class="ja jb" aria-hidden="true"><span class="be b bf z dt">·</span></span><p class="be b ix iy dt"><span><a class="jc jd ah ai aj ak al am an ao ap aq ar eu je jf" rel="noopener follow" href="/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fab00f83c5330&amp;operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2F%40fadop3%2Fnavigating-the-complexity-of-acquiring-multiple-resource-group-scopes-in-oauth-74527886921c&amp;user=Fabian+Peschke&amp;userId=ab00f83c5330&amp;source=post_page-ab00f83c5330----74527886921c---------------------post_header-----------">Follow</a></span></p></div></div></span></div></div><div class="l jg"><span class="be b bf z dt"><div class="ab cm jh ji jj"><span class="be b bf z dt"><div class="ab ae"><span data-testid="storyReadTime">10 min read</span><div class="jk jl l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="be b bf z dt">·</span></span></div><span data-testid="storyPublishDate">Jan 14</span></div></span></div></span></div></div></div><div class="ab co jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb"><div class="h k w fd fe q"><div class="kr l"><div class="ab q ks"><div class="pw-multi-vote-icon fg kt ku kv kw"><div class=""><div class="kx ky kz la lb lc ld am le lf lg kw"><svg width="24" height="24" viewBox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" clip-rule="evenodd" d="M11.37.83L12 3.28l.63-2.45h-1.26zM15.42 1.84l-1.18-.39-.34 2.5 1.52-2.1zM9.76 1.45l-1.19.4 1.53 2.1-.34-2.5zM20.25 11.84l-2.5-4.4a1.42 1.42 0 0 0-.93-.64.96.96 0 0 0-.75.18c-.25.19-.4.42-.45.7l.05.05 2.35 4.13c1.62 2.95 1.1 5.78-1.52 8.4l-.46.41c1-.13 1.93-.6 2.78-1.45 2.7-2.7 2.51-5.59 1.43-7.38zM12.07 9.01c-.13-.69.08-1.3.57-1.77l-2.06-2.07a1.12 1.12 0 0 0-1.56 0c-.15.15-.22.34-.27.53L12.07 9z"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M14.74 8.3a1.13 1.13 0 0 0-.73-.5.67.67 0 0 0-.53.13c-.15.12-.59.46-.2 1.3l1.18 2.5a.45.45 0 0 1-.23.76.44.44 0 0 1-.48-.25L7.6 6.11a.82.82 0 1 0-1.15 1.15l3.64 3.64a.45.45 0 1 1-.63.63L5.83 7.9 4.8 6.86a.82.82 0 0 0-1.33.9c.04.1.1.18.18.26l1.02 1.03 3.65 3.64a.44.44 0 0 1-.15.73.44.44 0 0 1-.48-.1L4.05 9.68a.82.82 0 0 0-1.4.57.81.81 0 0 0 .24.58l1.53 1.54 2.3 2.28a.45.45 0 0 1-.64.63L3.8 13a.81.81 0 0 0-1.39.57c0 .22.09.43.24.58l4.4 4.4c2.8 2.8 5.5 4.12 8.68.94 2.27-2.28 2.71-4.6 1.34-7.1l-2.32-4.08z"></path></svg></div></div></div><div class="pw-multi-vote-count l lh li lj lk ll lm ln"><p class="be b du z dt"><span class="ky">--</span></p></div></div></div><div><div class="bl" aria-hidden="false"><button class="ao kx lo lp ab q fh lq lr" aria-label="responses"><svg width="24" height="24" viewBox="0 0 24 24" class="ls"><path d="M18 16.8a7.14 7.14 0 0 0 2.24-5.32c0-4.12-3.53-7.48-8.05-7.48C7.67 4 4 7.36 4 11.48c0 4.13 3.67 7.48 8.2 7.48a8.9 8.9 0 0 0 2.38-.32c.23.2.48.39.75.56 1.06.69 2.2 1.04 3.4 1.04.22 0 .4-.11.48-.29a.5.5 0 0 0-.04-.52 6.4 6.4 0 0 1-1.16-2.65v.02zm-3.12 1.06l-.06-.22-.32.1a8 8 0 0 1-2.3.33c-4.03 0-7.3-2.96-7.3-6.59S8.17 4.9 12.2 4.9c4 0 7.1 2.96 7.1 6.6 0 1.8-.6 3.47-2.02 4.72l-.2.16v.26l.02.3a6.74 6.74 0 0 0 .88 2.4 5.27 5.27 0 0 1-2.17-.86c-.28-.17-.72-.38-.94-.59l.01-.02z"></path></svg></button></div></div></div><div class="ab q kc kd ke kf kg kh ki kj kk kl km kn ko kp kq"><div class="lt k j i d"></div><div class="h k"></div><div class="fa lu cm"><div class="l ae"><div class="ab ca"><div class="lv lw lx ly lz ma ch bg"><div class="ab"><div class="bl bg" aria-hidden="false"><div><div class="bl" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af fh ah ai aj ak al mb an ao ap eu mc md lr me mf mg mh mi s mj mk ml mm mn mo mp u mq mr ms"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0zm9-10a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm3.38 10.42l-4.6 3.06a.5.5 0 0 1-.78-.41V8.93c0-.4.45-.63.78-.41l4.6 3.06c.3.2.3.64 0 .84z" fill="currentColor"></path></svg><div class="j i d"><p class="be b bf z dt">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bl" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bl" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af fh ah ai aj ak al mb an ao ap eu mc md lr me mf mg mh mi s mj mk ml mm mn mo mp u mq mr ms"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M15.22 4.93a.42.42 0 0 1-.12.13h.01a.45.45 0 0 1-.29.08.52.52 0 0 1-.3-.13L12.5 3v7.07a.5.5 0 0 1-.5.5.5.5 0 0 1-.5-.5V3.02l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.8a.42.42 0 0 1 .07.5zm-.1.14zm.88 2h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11a2 2 0 0 1-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.14c.1.1.15.22.15.35a.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9V8.96c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1z" fill="currentColor"></path></svg><div class="j i d"><p class="be b bf z dt">Share</p></div></button></div></div></div></div></div></div></div></div></div><figure class="mw mx my mz na nb mt mu paragraph-image"><div role="button" tabindex="0" class="nc nd fg ne bg nf"><div class="mt mu mv"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*ytetQ6n7dB1Sm8e_wbcPBw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*ytetQ6n7dB1Sm8e_wbcPBw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*ytetQ6n7dB1Sm8e_wbcPBw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*ytetQ6n7dB1Sm8e_wbcPBw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*ytetQ6n7dB1Sm8e_wbcPBw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*ytetQ6n7dB1Sm8e_wbcPBw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ytetQ6n7dB1Sm8e_wbcPBw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*ytetQ6n7dB1Sm8e_wbcPBw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*ytetQ6n7dB1Sm8e_wbcPBw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*ytetQ6n7dB1Sm8e_wbcPBw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*ytetQ6n7dB1Sm8e_wbcPBw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*ytetQ6n7dB1Sm8e_wbcPBw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*ytetQ6n7dB1Sm8e_wbcPBw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*ytetQ6n7dB1Sm8e_wbcPBw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bg ma ng c" width="700" height="700" loading="eager" role="presentation"/></picture></div></div><figcaption class="nh fc ni mt mu nj nk be b bf z dt">Picture generated by Dall-e</figcaption></figure><h2 id="6e74" class="nl nm gr be nn no np dx nq nr ns dz nt nu nv nw nx ny nz oa ob oc od oe of og bj">Multi scope authentication using Microsoft Entra ID</h2><p id="aaed" class="pw-post-body-paragraph oh oi gr oj b hp ok ol om hs on oo op nu oq or os ny ot ou ov oc ow ox oy oz gk bj">OAuth 2.0 is a key technology in web development, especially when it comes to login and permissions. It allows apps to get limited access to user accounts on services like Facebook, Google, GitHub, and Microsoft, using HTTP requests. Managing access to different types of user data or actions (known as “scopes”) within OAuth is a challenging task for developers. This is tricky because each service (like Facebook or Microsoft) has its own set of rules for access, and giving access too broadly can lead to security issues.</p></div></div></div><div class="ab ca pa pb pc pd" role="separator"><span class="pe bx bl pf pg ph"></span><span class="pe bx bl pf pg ph"></span><span class="pe bx bl pf pg"></span></div><div class="gk gl gm gn go"><div class="ab ca"><div class="ch bg fw fx fy fz"><h1 id="0519" class="pi nm gr be nn pj pk hr nq pl pm hu nt pn po pp pq pr ps pt pu pv pw px py pz bj">Understanding the Challenge</h1><p id="123b" class="pw-post-body-paragraph oh oi gr oj b hp ok ol om hs on oo op nu oq or os ny ot ou ov oc ow ox oy oz gk bj">A resource scope, in OAuth terms, is a permission that defines the extent of access that an application can have on a user’s account. In simple scenarios, where an app requires access to a single type of resource, managing scopes is fairly straightforward. However, complications arise when an application needs to interact with multiple resource groups, each requiring different scopes of access.</p><p id="399a" class="pw-post-body-paragraph oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz gk bj">Consider an application that requires access to both a user’s Microsoft Graph data and specific Azure Blob Storage resources. Each of these resources has its own set of scopes, and obtaining consent for each, especially in a user-friendly and secure manner, can be challenging. The key difficulties include:</p><ol class=""><li id="12af" class="oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz qf qg qh bj">User Experience: Ensuring that the user understands what permissions they are granting and why they are necessary without having to authorize multiple times.</li><li id="6061" class="oh oi gr oj b hp qi ol om hs qj oo op nu qk or os ny ql ou ov oc qm ox oy oz qf qg qh bj">Security: Limiting the scopes to the minimum required, thereby adhering to the principle of least privilege.</li><li id="aafd" class="oh oi gr oj b hp qi ol om hs qj oo op nu qk or os ny ql ou ov oc qm ox oy oz qf qg qh bj">Technical Complexity: Handling multiple redirects, tokens, and potential consent screens in a seamless workflow.</li></ol><h1 id="2db1" class="pi nm gr be nn pj qn hr nq pl qo hu nt pn qp pp pq pr qq pt pu pv qr px py pz bj">Prerequisites</h1><ul class=""><li id="72bd" class="oh oi gr oj b hp ok ol om hs on oo op nu oq or os ny ot ou ov oc ow ox oy oz qs qg qh bj"><a class="af qt" href="https://azure.microsoft.com/de-de/free/search/?ef_id=_k_Cj0KCQiAtOmsBhCnARIsAGPa5ybZ9JNjx9iIVRNiAijVxye52TuOWcBghfIqLErKN9U36ED3GtRqdNIaAhIzEALw_wcB_k_&amp;OCID=AIDcmmzzaokddl_SEM__k_Cj0KCQiAtOmsBhCnARIsAGPa5ybZ9JNjx9iIVRNiAijVxye52TuOWcBghfIqLErKN9U36ED3GtRqdNIaAhIzEALw_wcB_k_&amp;gad_source=1&amp;gclid=Cj0KCQiAtOmsBhCnARIsAGPa5ybZ9JNjx9iIVRNiAijVxye52TuOWcBghfIqLErKN9U36ED3GtRqdNIaAhIzEALw_wcB" rel="noopener ugc nofollow" target="_blank">Microsoft Azure Subscription</a></li><li id="6173" class="oh oi gr oj b hp qi ol om hs qj oo op nu qk or os ny ql ou ov oc qm ox oy oz qs qg qh bj">Python knowledge</li></ul><h1 id="7d00" class="pi nm gr be nn pj qn hr nq pl qo hu nt pn qp pp pq pr qq pt pu pv qr px py pz bj">Implementation</h1><p id="f4a5" class="pw-post-body-paragraph oh oi gr oj b hp ok ol om hs on oo op nu oq or os ny ot ou ov oc ow ox oy oz gk bj">The implementation can be found <a class="af qt" href="https://github.com/Fadope1/MultiScopeAuth" rel="noopener ugc nofollow" target="_blank">here</a>. It uses FastApi both as backend and also to serve the HTML/ Javascript to the user for simplicity.</p><h2 id="59bf" class="nl nm gr be nn no np dx nq nr ns dz nt nu nv nw nx ny nz oa ob oc od oe of og bj">Azure Setup</h2><p id="30e3" class="pw-post-body-paragraph oh oi gr oj b hp ok ol om hs on oo op nu oq or os ny ot ou ov oc ow ox oy oz gk bj">We will be using Azure to setup Entra ID for the authentication. Here you could also add different OAuth Providers like Google, Apple, Github…</p><p id="663d" class="pw-post-body-paragraph oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz gk bj"><strong class="oj gs">Creating the app registration.<br/></strong>To setup the app registration on Azure go to “Microsoft Entra ID&gt;App registration&gt;new registration”.</p><figure class="mw mx my mz na nb mt mu paragraph-image"><div role="button" tabindex="0" class="nc nd fg ne bg nf"><div class="mt mu qu"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*eYPCng-S_jhaAOEDVMxMvg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*eYPCng-S_jhaAOEDVMxMvg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*eYPCng-S_jhaAOEDVMxMvg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*eYPCng-S_jhaAOEDVMxMvg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*eYPCng-S_jhaAOEDVMxMvg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*eYPCng-S_jhaAOEDVMxMvg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eYPCng-S_jhaAOEDVMxMvg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*eYPCng-S_jhaAOEDVMxMvg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*eYPCng-S_jhaAOEDVMxMvg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*eYPCng-S_jhaAOEDVMxMvg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*eYPCng-S_jhaAOEDVMxMvg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*eYPCng-S_jhaAOEDVMxMvg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*eYPCng-S_jhaAOEDVMxMvg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*eYPCng-S_jhaAOEDVMxMvg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="A picture showing the 3 steps to creating a new app registration. 1. Go to portal.azure.com the to the ms entra id tab. 2. Click on app registration. 3. Click on new app registration." class="bg ma ng c" width="700" height="476" loading="lazy"/></picture></div></div></figure><p id="2ceb" class="pw-post-body-paragraph oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz gk bj"><strong class="oj gs">Adding redirect URI as web app.<br/></strong>Now we need to fill in some information needed for the app registration. We need to give it a suitable name, which would ideally be a name similar to you project name. We need to also set a redirect uri. This URI needs to be of type Web for our case. Here we can define the allowed redirect URI that Microsoft will redirect the authentication back after the flow has finished. Regardless if it finished with errors or not. For now we will set it to localhost only. The endpoint will be implemented later on.</p><figure class="mw mx my mz na nb mt mu paragraph-image"><div role="button" tabindex="0" class="nc nd fg ne bg nf"><div class="mt mu qv"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*gXW6KEOgcy-TZ4ABrCNoOQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*gXW6KEOgcy-TZ4ABrCNoOQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*gXW6KEOgcy-TZ4ABrCNoOQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*gXW6KEOgcy-TZ4ABrCNoOQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*gXW6KEOgcy-TZ4ABrCNoOQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*gXW6KEOgcy-TZ4ABrCNoOQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gXW6KEOgcy-TZ4ABrCNoOQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*gXW6KEOgcy-TZ4ABrCNoOQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*gXW6KEOgcy-TZ4ABrCNoOQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*gXW6KEOgcy-TZ4ABrCNoOQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*gXW6KEOgcy-TZ4ABrCNoOQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*gXW6KEOgcy-TZ4ABrCNoOQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*gXW6KEOgcy-TZ4ABrCNoOQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*gXW6KEOgcy-TZ4ABrCNoOQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bg ma ng c" width="700" height="449" loading="lazy" role="presentation"/></picture></div></div></figure><p id="66c4" class="pw-post-body-paragraph oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz gk bj"><strong class="oj gs">Create secret for the app registration.<br/></strong>To access this app registration via the api we need to have a secret. This can be created by going under “your-app-registration&gt;Certificates &amp; secrets&gt;New client secret”</p><figure class="mw mx my mz na nb mt mu paragraph-image"><div role="button" tabindex="0" class="nc nd fg ne bg nf"><div class="mt mu qv"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*xD_i6AGYN1di5-XQszphDg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*xD_i6AGYN1di5-XQszphDg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*xD_i6AGYN1di5-XQszphDg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*xD_i6AGYN1di5-XQszphDg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*xD_i6AGYN1di5-XQszphDg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*xD_i6AGYN1di5-XQszphDg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xD_i6AGYN1di5-XQszphDg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*xD_i6AGYN1di5-XQszphDg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*xD_i6AGYN1di5-XQszphDg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*xD_i6AGYN1di5-XQszphDg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*xD_i6AGYN1di5-XQszphDg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*xD_i6AGYN1di5-XQszphDg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*xD_i6AGYN1di5-XQszphDg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*xD_i6AGYN1di5-XQszphDg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bg ma ng c" width="700" height="449" loading="lazy" role="presentation"/></picture></div></div></figure><p id="9333" class="pw-post-body-paragraph oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz gk bj">After giving the secret an appropriate name and expiration date copy the secret. We will be using a “.env” file to store our secrets locally. So go ahead and create a new folder with a “.env” file and put “CLIENT_SECRET=&lt;your-secret&gt;” into the file. Also head over to your app registration overview and copy the tenant id and client id and put it inside your “.env” file with naming:<br/>TENANT_ID=&lt;your-tenant-id&gt;<br/>CLIENT_ID=&lt;your-tenant-id&gt;</p><p id="fb18" class="pw-post-body-paragraph oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz gk bj">Also add a variable called BASE_URL to make your final “.env“ file look like this:</p><pre class="mw mx my mz na qw qx qy bo qz ba bj"><span id="e1cf" class="ra nm gr qx b bf rb rc l rd re">CLIENT_SECRET=dawdj9823d293hdd28u3d92u3d8u<br/>TENANT_ID=myidvalue239i10ojdodwad<br/>CLIENT_ID=myotheridvaluedj289dh2983h<br/>BASE_URL=http://localhost:8080</span></pre><p id="d360" class="pw-post-body-paragraph oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz gk bj"><strong class="oj gs">Add app scopes<br/></strong>As the last step lets add all our scopes that the app will be using. Go to the app registration under “API permission” and create “Add a permission”. Then simply select the scopes needed for your app.</p><figure class="mw mx my mz na nb mt mu paragraph-image"><div role="button" tabindex="0" class="nc nd fg ne bg nf"><div class="mt mu rf"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*xoNM0XB_ak_rRp4xPhnVFQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*xoNM0XB_ak_rRp4xPhnVFQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*xoNM0XB_ak_rRp4xPhnVFQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*xoNM0XB_ak_rRp4xPhnVFQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*xoNM0XB_ak_rRp4xPhnVFQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*xoNM0XB_ak_rRp4xPhnVFQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xoNM0XB_ak_rRp4xPhnVFQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*xoNM0XB_ak_rRp4xPhnVFQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*xoNM0XB_ak_rRp4xPhnVFQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*xoNM0XB_ak_rRp4xPhnVFQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*xoNM0XB_ak_rRp4xPhnVFQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*xoNM0XB_ak_rRp4xPhnVFQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*xoNM0XB_ak_rRp4xPhnVFQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*xoNM0XB_ak_rRp4xPhnVFQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bg ma ng c" width="700" height="255" loading="lazy" role="presentation"/></picture></div></div></figure><p id="2918" class="pw-post-body-paragraph oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz gk bj">Now Azure is successfully configured so lets start by implementing our frontend.</p></div></div></div><div class="ab ca pa pb pc pd" role="separator"><span class="pe bx bl pf pg ph"></span><span class="pe bx bl pf pg ph"></span><span class="pe bx bl pf pg"></span></div><div class="gk gl gm gn go"><div class="ab ca"><div class="ch bg fw fx fy fz"><h2 id="ba10" class="nl nm gr be nn no np dx nq nr ns dz nt nu nv nw nx ny nz oa ob oc od oe of og bj">Frontend Workflow</h2><p id="4bc5" class="pw-post-body-paragraph oh oi gr oj b hp ok ol om hs on oo op nu oq or os ny ot ou ov oc ow ox oy oz gk bj">The authentication has 3 stages:</p><ul class=""><li id="3924" class="oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz qs qg qh bj">Silent Login: Happens when the user opens the website and initiates an OAuth flow without user interaction to check if the user is already authenticated and has the necessary permissions.</li><li id="cee8" class="oh oi gr oj b hp qi ol om hs qj oo op nu qk or os ny ql ou ov oc qm ox oy oz qs qg qh bj">Regular Login: Redirects to a login page, indicating that user interaction is required.</li><li id="5163" class="oh oi gr oj b hp qi ol om hs qj oo op nu qk or os ny ql ou ov oc qm ox oy oz qs qg qh bj">Consent and Token Acquisition: If additional consent is needed for new scopes, the user is redirected to a consent page.</li></ul><p id="ed5b" class="pw-post-body-paragraph oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz gk bj">These stages interact with each other like so:</p><figure class="mw mx my mz na nb mt mu paragraph-image"><div role="button" tabindex="0" class="nc nd fg ne bg nf"><div class="mt mu rg"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*KwI4TqbYQreyLFc70pWZbg.jpeg 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*KwI4TqbYQreyLFc70pWZbg.jpeg 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*KwI4TqbYQreyLFc70pWZbg.jpeg 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*KwI4TqbYQreyLFc70pWZbg.jpeg 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*KwI4TqbYQreyLFc70pWZbg.jpeg 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*KwI4TqbYQreyLFc70pWZbg.jpeg 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KwI4TqbYQreyLFc70pWZbg.jpeg 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*KwI4TqbYQreyLFc70pWZbg.jpeg 640w, https://miro.medium.com/v2/resize:fit:720/1*KwI4TqbYQreyLFc70pWZbg.jpeg 720w, https://miro.medium.com/v2/resize:fit:750/1*KwI4TqbYQreyLFc70pWZbg.jpeg 750w, https://miro.medium.com/v2/resize:fit:786/1*KwI4TqbYQreyLFc70pWZbg.jpeg 786w, https://miro.medium.com/v2/resize:fit:828/1*KwI4TqbYQreyLFc70pWZbg.jpeg 828w, https://miro.medium.com/v2/resize:fit:1100/1*KwI4TqbYQreyLFc70pWZbg.jpeg 1100w, https://miro.medium.com/v2/resize:fit:1400/1*KwI4TqbYQreyLFc70pWZbg.jpeg 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="A triangle picture showing the connection between all 3 stages explained before." class="bg ma ng c" width="700" height="559" loading="lazy"/></picture></div></div></figure><p id="7520" class="pw-post-body-paragraph oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz gk bj">To implement this we will be creating a simple HTML site. This site will be rendered by FastApi when the user is not authenticated yet.</p><pre class="mw mx my mz na qw qx qy bo qz ba bj"><span id="5c4f" class="ra nm gr qx b bf rb rc l rd re">&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>    &lt;head&gt;<br/>        &lt;title&gt;Auth required&lt;/title&gt;<br/>    &lt;/head&gt;<br/>    &lt;body&gt;<br/>        &lt;h1&gt;Not authorized&lt;/h1&gt;<br/>        &lt;p&gt;Please authorize by signing in using an MS account&lt;/p&gt;<br/>        &lt;button onclick=&quot;login()&quot;&gt;Authorize&lt;/button&gt;<br/>    &lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="bccc" class="pw-post-body-paragraph oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz gk bj">Lets also create a different HTML file that get displayed only when the user is authenticated.</p><pre class="mw mx my mz na qw qx qy bo qz ba bj"><span id="928d" class="ra nm gr qx b bf rb rc l rd re">&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>    &lt;head&gt;<br/>        &lt;title&gt;Sign In Successful&lt;/title&gt;<br/>    &lt;/head&gt;<br/>    &lt;body&gt;<br/>        &lt;h1&gt;Sign In Successful&lt;/h1&gt;<br/>        &lt;p&gt;Welcome! You have successfully signed in.&lt;/p&gt;<br/>    &lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="5eff" class="pw-post-body-paragraph oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz gk bj">Lets start to create the actual endpoints.</p></div></div></div><div class="ab ca pa pb pc pd" role="separator"><span class="pe bx bl pf pg ph"></span><span class="pe bx bl pf pg ph"></span><span class="pe bx bl pf pg"></span></div><div class="gk gl gm gn go"><div class="ab ca"><div class="ch bg fw fx fy fz"><h2 id="b879" class="nl nm gr be nn no np dx nq nr ns dz nt nu nv nw nx ny nz oa ob oc od oe of og bj">Backend Implementation</h2><p id="5bbd" class="pw-post-body-paragraph oh oi gr oj b hp ok ol om hs on oo op nu oq or os ny ot ou ov oc ow ox oy oz gk bj">This implementation requires some components:</p><ul class=""><li id="f3d0" class="oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz qs qg qh bj">OAuth Endpoints: Different FastAPI endpoints (<code class="cw rh ri rj qx b">/silent_login</code>, <code class="cw rh ri rj qx b">/login</code>, <code class="cw rh ri rj qx b">/consent</code>) handle various stages of the OAuth flow.</li><li id="c9e7" class="oh oi gr oj b hp qi ol om hs qj oo op nu qk or os ny ql ou ov oc qm ox oy oz qs qg qh bj">Token Acquisition: Upon successful authentication and consent, the app exchanges the authorization code for access tokens.</li><li id="4610" class="oh oi gr oj b hp qi ol om hs qj oo op nu qk or os ny ql ou ov oc qm ox oy oz qs qg qh bj">Scope Management: The backend is designed to handle both default and additional scopes, ensuring that the application requests only the necessary permissions. The scopes needed to be added beforehand. But its easy to add new scopes when first authorization has passed.</li><li id="8d9c" class="oh oi gr oj b hp qi ol om hs qj oo op nu qk or os ny ql ou ov oc qm ox oy oz qs qg qh bj">Endpoints to render the frontend HTML.</li></ul></div></div></div><div class="ab ca pa pb pc pd" role="separator"><span class="pe bx bl pf pg ph"></span><span class="pe bx bl pf pg ph"></span><span class="pe bx bl pf pg"></span></div><div class="gk gl gm gn go"><div class="ab ca"><div class="ch bg fw fx fy fz"><p id="b551" class="pw-post-body-paragraph oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz gk bj"><strong class="oj gs">Single scope authentication<br/></strong>Lets first create a simple endpoint to display our HTML:</p><pre class="mw mx my mz na qw qx qy bo qz ba bj"><span id="a4ec" class="ra nm gr qx b bf rb rc l rd re">from fastapi import APIRouter, Request, Response<br/>from fastapi.templating import Jinja2Templates<br/><br/>router = APIRouter()<br/>templates = Jinja2Templates(directory=&quot;frontend/templates&quot;)  # Ensure you have a &#x27;templates&#x27; directory<br/><br/><br/>def check_authorization(request: Request) -&gt; bool:<br/>    return True<br/><br/><br/>@router.get(&quot;/&quot;)<br/>async def home(request: Request, error: str | None=None) -&gt; Response:<br/>    if check_authorization(request) is True:<br/>        return templates.TemplateResponse(&quot;home.html&quot;, {&quot;request&quot;: request})<br/>    else:<br/>        return templates.TemplateResponse(&quot;unauthorized.html&quot;, {&quot;request&quot;: request})</span></pre><p id="28bc" class="pw-post-body-paragraph oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz gk bj">For now the authentication is simply set to True, meaning the user is always authenticated. With this we can easily switch it to False to test if our Frontend is working.</p><p id="55d7" class="pw-post-body-paragraph oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz gk bj">The next step is to implement a simple user session to store data between requests. This is needed to generate a code verifier to use again in the callback endpoint. Lets implement a simple user session that is stored in memory.</p><pre class="mw mx my mz na qw qx qy bo qz ba bj"><span id="c88a" class="ra nm gr qx b bf rb rc l rd re">from dotenv import load_dotenv<br/>load_dotenv(&quot;../.env&quot;)<br/><br/>from typing import Callable<br/>import uuid<br/><br/>from fastapi import FastAPI, Request<br/><br/>app = FastAPI(<br/>    title=&quot;Test multi scope api&quot;,<br/>    debug=__debug__,<br/>    docs_url=&quot;/api/docs&quot;,<br/>    redoc_url=&quot;/api/redoc&quot;<br/>)<br/><br/>session_store = {}<br/><br/><br/>@app.middleware(&quot;http&quot;)<br/>async def session_middleware(request: Request, call_next: Callable):<br/>    &quot;&quot;&quot;Add basic user session to request&quot;&quot;&quot;<br/>    session_id = request.cookies.get(&quot;session_id&quot;, None)<br/>    if session_id not in session_store:<br/>        session_id = str(uuid.uuid4())<br/>        session_store[session_id] = {}<br/><br/>    request.state.session = session_store[session_id]<br/><br/>    response = await call_next(request)<br/><br/>    response.set_cookie(key=&quot;session_id&quot;, value=session_id)<br/>    return response</span></pre><p id="1c53" class="pw-post-body-paragraph oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz gk bj">Keep in mind that in a productive system this needs to be replaced by a correct implementation using encryption and a better way of storing the data.</p><p id="f889" class="pw-post-body-paragraph oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz gk bj">Next we create the OAuth endpoints. The OAuth router is under “api/v1/auth/oauth”. The whole structure can be found <a class="af qt" href="https://github.com/Fadope1/MultiScopeAuth" rel="noopener ugc nofollow" target="_blank">here</a>.</p><p id="9c6a" class="pw-post-body-paragraph oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz gk bj">Lets start by implementing simple authentication endpoints.</p><pre class="mw mx my mz na qw qx qy bo qz ba bj"><span id="fe3d" class="ra nm gr qx b bf rb rc l rd re">import requests<br/>import hashlib<br/>import base64<br/>import os<br/><br/>from fastapi import APIRouter, Request<br/>from fastapi.responses import RedirectResponse<br/><br/>router = APIRouter()<br/><br/>client_secret = os.getenv(&quot;CLIENT_SECRET&quot;)<br/>client_id = os.getenv(&quot;CLIENT_ID&quot;)<br/>tenant_id = os.getenv(&quot;TENANT_ID&quot;)<br/>base_url = os.getenv(&quot;BASE_URL&quot;)<br/>BASE_AUTH_URL = f&quot;https://login.microsoftonline.com/{tenant_id}/oauth2/v2.0&quot;<br/><br/>DEFAULT_SCOPE = &quot;https://graph.microsoft.com/User.Read&quot;<br/><br/><br/>@router.get(&quot;/login&quot;)<br/>async def login(request: Request, scope: str=DEFAULT_SCOPE):<br/>    code_verifier = base64.urlsafe_b64encode(os.urandom(40)).decode(&#x27;utf-8&#x27;).rstrip(&#x27;=&#x27;)<br/>    code_challenge = base64.urlsafe_b64encode(<br/>        hashlib.sha256(code_verifier.encode()).digest()<br/>    ).decode(&#x27;utf-8&#x27;).rstrip(&#x27;=&#x27;)<br/><br/>    request.state.session[&#x27;code_verifier&#x27;] = code_verifier<br/><br/>    params = {<br/>        &quot;client_id&quot;: client_id,<br/>        &quot;response_type&quot;: &quot;code&quot;,<br/>        &quot;redirect_uri&quot;: f&quot;{base_url}/api/v1/auth/oauth/callback&quot;,<br/>        &quot;response_mode&quot;: &quot;query&quot;,<br/>        &quot;scope&quot;: scope,<br/>        &quot;code_challenge&quot;: code_challenge,<br/>        &quot;code_challenge_method&quot;: &quot;S256&quot;<br/>    }<br/>    login_url = f&quot;{BASE_AUTH_URL}/authorize?&quot; + &quot;&amp;&quot;.join([f&quot;{k}={v}&quot; for k, v in params.items()])<br/>    return RedirectResponse(url=login_url)<br/><br/><br/>@router.get(&quot;/callback&quot;)<br/>async def callback(<br/>        request: Request,<br/>        code: str | None=None,<br/>        session_state: str | None=None,<br/>        error: str=None,<br/>        error_subcode: str=None,<br/>        error_description: str=None<br/>    ) -&gt; RedirectResponse:<br/>    code_verifier: str = request.state.session.get(&#x27;code_verifier&#x27;)<br/>    scope: str = request.state.session[&#x27;scope&#x27;].split(&quot; &quot;)[0]<br/><br/>    url = f&quot;{BASE_AUTH_URL}/token&quot;<br/>    payload = {<br/>        &quot;grant_type&quot;: &quot;authorization_code&quot;,<br/>        &quot;client_id&quot;: client_id,<br/>        &quot;client_secret&quot;: client_secret,<br/>        &quot;scope&quot;: scope,<br/>        &quot;code&quot;: code,<br/>        &quot;redirect_uri&quot;: f&quot;{base_url}/api/v1/auth/oauth/callback&quot;,<br/>        &quot;code_verifier&quot;: code_verifier<br/>    }<br/>    response = requests.post(url, data=payload)<br/>    response.raise_for_status()<br/>    <br/>    data = response.json()<br/>    request.state.session[DEFAULT_SCOPE] = data[&quot;access_token&quot;]<br/><br/>    return RedirectResponse(url=base_url) # go back to the homepage</span></pre><p id="f949" class="pw-post-body-paragraph oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz gk bj">This API will authenticate against a single scope and after the process is done it will redirect to the homepage. To implement the authentication in the frontend lets change the Frontend API to dynamically display different HTML sites based on authentication:</p><pre class="mw mx my mz na qw qx qy bo qz ba bj"><span id="4d64" class="ra nm gr qx b bf rb rc l rd re">def check_authorization(request: Request) -&gt; bool:<br/>    return &quot;https://graph.microsoft.com/User.Read&quot; in request.state.session<br/><br/><br/>@router.get(&quot;/&quot;)<br/>async def home(request: Request, error: str | None=None) -&gt; Response:<br/>    if check_authorization(request) is True:<br/>        return templates.TemplateResponse(&quot;home.html&quot;, {&quot;request&quot;: request})<br/>    else:<br/>        return templates.TemplateResponse(&quot;unauthorized.html&quot;, {&quot;request&quot;: request})</span></pre><p id="2c6b" class="pw-post-body-paragraph oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz gk bj">Also add the required script to the HTML site to start authentication on button press.</p><pre class="mw mx my mz na qw qx qy bo qz ba bj"><span id="f92e" class="ra nm gr qx b bf rb rc l rd re">&lt;script&gt;<br/>  function login() {<br/>      regularLogin();<br/>  }<br/><br/>  function regularLogin() {<br/>      // Regular login process<br/>      window.location.href = &#x27;/api/v1/auth/oauth/login&#x27;;<br/>  }<br/>&lt;/script&gt;</span></pre><p id="2f10" class="pw-post-body-paragraph oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz gk bj">This will now check if the authentication was successful and the scope is set inside the user session.</p></div></div></div><div class="ab ca pa pb pc pd" role="separator"><span class="pe bx bl pf pg ph"></span><span class="pe bx bl pf pg ph"></span><span class="pe bx bl pf pg"></span></div><div class="gk gl gm gn go"><div class="ab ca"><div class="ch bg fw fx fy fz"><p id="820d" class="pw-post-body-paragraph oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz gk bj"><strong class="oj gs">Multi scope authentication<br/></strong>The key to acquiring multiple tokens for multiple scopes is to add “offline_ access” to the initial scope separated with spaces. This will add a refresh token to the response that can be used to claim different scopes. This is all you need for getting a new token using a refresh token:</p><pre class="mw mx my mz na qw qx qy bo qz ba bj"><span id="1cf4" class="ra nm gr qx b bf rb rc l rd re">url = f&quot;{BASE_AUTH_URL}/token&quot;<br/>payload = {<br/>    &quot;grant_type&quot;: &quot;refresh_token&quot;, # set the grant_type to refresh_token<br/>    &quot;client_id&quot;: client_id,<br/>    &quot;client_secret&quot;: client_secret,<br/>    &quot;refresh_token&quot;: refresh_token,<br/>    &quot;scope&quot;: new_scope<br/>}<br/>response = requests.post(url, data=payload)<br/>response.raise_for_status()<br/>data = response.json()<br/>new_token = data[&quot;access_token&quot;]</span></pre><p id="9454" class="pw-post-body-paragraph oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz gk bj">Lets also create two additional endpoints. One for trying to silently login and one for asking for consent for the user. This can be done by specifying the prompt perimeter when calling the OAuth API. The final code now looks like this:</p><pre class="mw mx my mz na qw qx qy bo qz ba bj"><span id="b12a" class="ra nm gr qx b bf rb rc l rd re">... # imports and basic config from before<br/><br/>DEFAULT_SCOPE = &quot;https://graph.microsoft.com/User.Read&quot;<br/>ADDITIONAL_SCOPES = &quot;https://newmultiscopetest.blob.core.windows.net/user_impersonation&quot;<br/>ALL_SCOPES = DEFAULT_SCOPE + &quot; &quot; + ADDITIONAL_SCOPES<br/><br/><br/>@router.get(&quot;/silent_login&quot;)<br/>async def silent_login(request: Request, scope: str=DEFAULT_SCOPE):<br/>    code_verifier = base64.urlsafe_b64encode(os.urandom(40)).decode(&#x27;utf-8&#x27;).rstrip(&#x27;=&#x27;)<br/>    code_challenge = base64.urlsafe_b64encode(<br/>        hashlib.sha256(code_verifier.encode()).digest()<br/>    ).decode(&#x27;utf-8&#x27;).rstrip(&#x27;=&#x27;)<br/><br/>    request.state.session[&#x27;code_verifier&#x27;] = code_verifier<br/>    request.state.session[&#x27;scope&#x27;] = scope<br/>    if &quot;offline_access&quot; not in scope:<br/>        scope += &quot; offline_access&quot;<br/><br/>    params = {<br/>        &quot;client_id&quot;: client_id,<br/>        &quot;response_type&quot;: &quot;code&quot;,<br/>        &quot;redirect_uri&quot;: f&quot;{base_url}/api/v1/auth/oauth/callback&quot;,<br/>        &quot;response_mode&quot;: &quot;query&quot;,<br/>        &quot;scope&quot;: scope,<br/>        &quot;prompt&quot;: &quot;none&quot;,<br/>        &quot;code_challenge&quot;: code_challenge,<br/>        &quot;code_challenge_method&quot;: &quot;S256&quot;<br/>    }<br/>    login_url = f&quot;{BASE_AUTH_URL}/authorize?&quot; + &quot;&amp;&quot;.join([f&quot;{k}={v}&quot; for k, v in params.items()])<br/>    return RedirectResponse(url=login_url)<br/><br/><br/>@router.get(&quot;/login&quot;)<br/>async def login(request: Request, scope: str=DEFAULT_SCOPE):<br/>    code_verifier = base64.urlsafe_b64encode(os.urandom(40)).decode(&#x27;utf-8&#x27;).rstrip(&#x27;=&#x27;)<br/>    code_challenge = base64.urlsafe_b64encode(<br/>        hashlib.sha256(code_verifier.encode()).digest()<br/>    ).decode(&#x27;utf-8&#x27;).rstrip(&#x27;=&#x27;)<br/><br/>    request.state.session[&#x27;code_verifier&#x27;] = code_verifier<br/>    request.state.session[&#x27;scope&#x27;] = scope<br/>    if &quot;offline_access&quot; not in scope:<br/>        scope += &quot; offline_access&quot;<br/><br/>    params = {<br/>        &quot;client_id&quot;: client_id,<br/>        &quot;response_type&quot;: &quot;code&quot;,<br/>        &quot;redirect_uri&quot;: f&quot;{base_url}/api/v1/auth/oauth/callback&quot;,<br/>        &quot;response_mode&quot;: &quot;query&quot;,<br/>        &quot;scope&quot;: scope,<br/>        &quot;code_challenge&quot;: code_challenge,<br/>        &quot;code_challenge_method&quot;: &quot;S256&quot;<br/>    }<br/>    login_url = f&quot;{BASE_AUTH_URL}/authorize?&quot; + &quot;&amp;&quot;.join([f&quot;{k}={v}&quot; for k, v in params.items()])<br/>    return RedirectResponse(url=login_url)<br/><br/><br/>@router.get(&quot;/consent&quot;)<br/>async def login(request: Request, scope: str=ALL_SCOPES):<br/>    code_verifier = base64.urlsafe_b64encode(os.urandom(40)).decode(&#x27;utf-8&#x27;).rstrip(&#x27;=&#x27;)<br/>    code_challenge = base64.urlsafe_b64encode(<br/>        hashlib.sha256(code_verifier.encode()).digest()<br/>    ).decode(&#x27;utf-8&#x27;).rstrip(&#x27;=&#x27;)<br/><br/>    request.state.session[&#x27;code_verifier&#x27;] = code_verifier<br/>    request.state.session[&#x27;scope&#x27;] = scope<br/>    <br/>    if &quot;offline_access&quot; not in scope:<br/>        scope += &quot; offline_access&quot;<br/><br/>    params = {<br/>        &quot;client_id&quot;: client_id,<br/>        &quot;response_type&quot;: &quot;code&quot;,<br/>        &quot;redirect_uri&quot;: f&quot;{base_url}/api/v1/auth/oauth/callback&quot;,<br/>        &quot;response_mode&quot;: &quot;query&quot;,<br/>        &quot;scope&quot;: scope,<br/>        &quot;code_challenge&quot;: code_challenge,<br/>        &#x27;prompt&#x27;: &#x27;consent&#x27;,<br/>        &quot;code_challenge_method&quot;: &quot;S256&quot;<br/>    }<br/>    login_url = f&quot;{BASE_AUTH_URL}/authorize?&quot; + &quot;&amp;&quot;.join([f&quot;{k}={v}&quot; for k, v in params.items()])<br/>    return RedirectResponse(url=login_url)<br/><br/><br/>@router.get(&quot;/callback&quot;)<br/>async def callback(<br/>        request: Request,<br/>        code: str | None=None,<br/>        session_state: str | None=None,<br/>        error: str=None,<br/>        error_subcode: str=None,<br/>        error_description: str=None<br/>    ) -&gt; RedirectResponse:<br/>    if code is None:<br/>        if error == &quot;login_required&quot;:<br/>            return RedirectResponse(url=f&quot;{base_url}/api/v1/auth/oauth/login&quot;)<br/>        elif error == &quot;consent_required&quot;:<br/>            return RedirectResponse(url=f&quot;{base_url}/api/v1/auth/oauth/consent&quot;)<br/>        else:<br/>            raise HTTPException(500, f&quot;{error}|{error_description}&quot;)<br/>    <br/>    code_verifier: str = request.state.session.get(&#x27;code_verifier&#x27;)<br/>    scope: str = request.state.session[&#x27;scope&#x27;].split(&quot; &quot;)[0]<br/><br/>    data = await get_token_by_code(scope, code, code_verifier)<br/>    token = data[&#x27;access_token&#x27;]<br/>    refresh_token = data[&#x27;refresh_token&#x27;]<br/>    token_scopes = data[&#x27;scope&#x27;]<br/><br/>    request.state.session[scope] = token<br/>    request.state.session[&#x27;refresh_token&#x27;] = refresh_token<br/><br/>    missing_scopes = {scope for scope in ALL_SCOPES.split(&quot; &quot;) if scope not in token_scopes}<br/>    for scope in missing_scopes:<br/>        try:<br/>            data = await get_token_by_refresh_token(scope, refresh_token)<br/>            token = data[&quot;access_token&quot;]<br/>            request.state.session[scope] = token<br/>        except Exception as e:<br/>            print(e)<br/>        <br/>    request.state.session[&quot;scope&quot;] = None<br/><br/>    return RedirectResponse(url=base_url)<br/><br/><br/>async def get_token_by_code(<br/>        scope,<br/>        code,<br/>        code_verifier<br/>    ) -&gt; dict:<br/>    &quot;&quot;&quot;Acquire the token using refresh_token&quot;&quot;&quot;<br/>    url = f&quot;{BASE_AUTH_URL}/token&quot;<br/>    payload = {<br/>        &quot;grant_type&quot;: &quot;authorization_code&quot;,<br/>        &quot;client_id&quot;: client_id,<br/>        &quot;client_secret&quot;: client_secret,<br/>        &quot;scope&quot;: scope,<br/>        &quot;code&quot;: code,<br/>        &quot;redirect_uri&quot;: f&quot;{base_url}/api/v1/auth/oauth/callback&quot;,<br/>        &quot;code_verifier&quot;: code_verifier<br/>    }<br/>    response = requests.post(url, data=payload)<br/>    <br/>    response.raise_for_status()<br/>    data = response.json()<br/><br/>    return data<br/><br/><br/>async def get_token_by_refresh_token(<br/>        scope,<br/>        refresh_token<br/>    ) -&gt; dict:<br/>    &quot;&quot;&quot;Acquire the token using refresh_token&quot;&quot;&quot;<br/>    url = f&quot;{BASE_AUTH_URL}/token&quot;<br/>    payload = {<br/>        &quot;grant_type&quot;: &quot;refresh_token&quot;,<br/>        &quot;client_id&quot;: client_id,<br/>        &quot;client_secret&quot;: client_secret,<br/>        &quot;refresh_token&quot;: refresh_token,<br/>        &quot;scope&quot;: scope<br/>    }<br/>    response = requests.post(url, data=payload)<br/>    response.raise_for_status()<br/>    data = response.json()<br/><br/>    return data</span></pre><p id="6427" class="pw-post-body-paragraph oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz gk bj">Lets also add the changes to the frontend code to first authenticate using the silent_login endpoint:</p><pre class="mw mx my mz na qw qx qy bo qz ba bj"><span id="f922" class="ra nm gr qx b bf rb rc l rd re">function login() {<br/>    silentLogin();<br/>}<br/><br/>function silentLogin() {<br/>    window.location.href = &#x27;/api/v1/auth/oauth/silent_login&#x27;;<br/>}</span></pre><p id="f0da" class="pw-post-body-paragraph oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz gk bj">Now when you press the authenticate button the API will:</p><ol class=""><li id="65e6" class="oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz qf qg qh bj">Try to log you in using existing credentials.</li><li id="8975" class="oh oi gr oj b hp qi ol om hs qj oo op nu qk or os ny ql ou ov oc qm ox oy oz qf qg qh bj">If this fails, try login you into your account.</li><li id="7e5d" class="oh oi gr oj b hp qi ol om hs qj oo op nu qk or os ny ql ou ov oc qm ox oy oz qf qg qh bj">If the consent is missing consent and login.</li></ol><p id="5605" class="pw-post-body-paragraph oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz gk bj">If both 1. and 2. fails. It will ask the user to consent to all scopes specified in the app registration:</p><figure class="mw mx my mz na nb mt mu paragraph-image"><div role="button" tabindex="0" class="nc nd fg ne bg nf"><div class="mt mu rk"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*DDa3Wp2dqWlmrJsjXgZ7BQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*DDa3Wp2dqWlmrJsjXgZ7BQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*DDa3Wp2dqWlmrJsjXgZ7BQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*DDa3Wp2dqWlmrJsjXgZ7BQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*DDa3Wp2dqWlmrJsjXgZ7BQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*DDa3Wp2dqWlmrJsjXgZ7BQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DDa3Wp2dqWlmrJsjXgZ7BQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*DDa3Wp2dqWlmrJsjXgZ7BQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*DDa3Wp2dqWlmrJsjXgZ7BQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*DDa3Wp2dqWlmrJsjXgZ7BQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*DDa3Wp2dqWlmrJsjXgZ7BQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*DDa3Wp2dqWlmrJsjXgZ7BQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*DDa3Wp2dqWlmrJsjXgZ7BQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*DDa3Wp2dqWlmrJsjXgZ7BQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bg ma ng c" width="700" height="796" loading="lazy" role="presentation"/></picture></div></div></figure><p id="6a74" class="pw-post-body-paragraph oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz gk bj">After successfully gaining the access token and refresh_token it claims all additional scopes.</p><h1 id="2f61" class="pi nm gr be nn pj qn hr nq pl qo hu nt pn qp pp pq pr qq pt pu pv qr px py pz bj">Conclusion</h1><p id="c3e5" class="pw-post-body-paragraph oh oi gr oj b hp ok ol om hs on oo op nu oq or os ny ot ou ov oc ow ox oy oz gk bj">Acquiring a second token for a different scope is not that hard after understanding how to get it. The hard part is to not authenticating the user multiple times and have a nice user flow. Keep in mind that the code is mostly just a Prove of Concept and should not be used in Production.</p><p id="f2f9" class="pw-post-body-paragraph oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz gk bj">The project can be found on Github: <a class="af qt" href="https://github.com/Fadope1/MultiScopeAuth" rel="noopener ugc nofollow" target="_blank">https://github.com/Fadope1/MultiScopeAuth</a></p><p id="2606" class="pw-post-body-paragraph oh oi gr oj b hp qa ol om hs qb oo op nu qc or os ny qd ou ov oc qe ox oy oz gk bj">If you liked this post please clap.</p></div></div></div></div></section></div></div></article><div class="ab ca"><div class="ch bg fw fx fy fz"></div></div></div><div class="ab ca"><div class="ch bg fw fx fy fz"><div class="rl rm ab jj"><div class="rn ab"><a class="ro ax am ao" rel="noopener follow" href="/tag/python?source=post_page-----74527886921c---------------python-----------------"><div class="rp fg cw rq gb rr rs be b bf z bj rt">Python</div></a></div><div class="rn ab"><a class="ro ax am ao" rel="noopener follow" href="/tag/microsoft-entra-id?source=post_page-----74527886921c---------------microsoft_entra_id-----------------"><div class="rp fg cw rq gb rr rs be b bf z bj rt">Microsoft Entra Id</div></a></div><div class="rn ab"><a class="ro ax am ao" rel="noopener follow" href="/tag/oauth?source=post_page-----74527886921c---------------oauth-----------------"><div class="rp fg cw rq gb rr rs be b bf z bj rt">Oauth</div></a></div><div class="rn ab"><a class="ro ax am ao" rel="noopener follow" href="/tag/microsoft?source=post_page-----74527886921c---------------microsoft-----------------"><div class="rp fg cw rq gb rr rs be b bf z bj rt">Microsoft</div></a></div><div class="rn ab"><a class="ro ax am ao" rel="noopener follow" href="/tag/azure?source=post_page-----74527886921c---------------azure-----------------"><div class="rp fg cw rq gb rr rs be b bf z bj rt">Azure</div></a></div></div></div></div><div class="l"></div><footer class="ru rv rw rx ry rz sa sb sc ab q sd se c"><div class="l ae"><div class="ab ca"><div class="ch bg fw fx fy fz"><div class="ab co sf"><div class="ab q ks"><div class="sg l"><span class="l sh si sj e d"><div class="ab q ks"><div class="pw-multi-vote-icon fg kt ku kv kw"><div class=""><div class="kx ky kz la lb lc ld am le lf lg kw"><svg width="24" height="24" viewBox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" clip-rule="evenodd" d="M11.37.83L12 3.28l.63-2.45h-1.26zM15.42 1.84l-1.18-.39-.34 2.5 1.52-2.1zM9.76 1.45l-1.19.4 1.53 2.1-.34-2.5zM20.25 11.84l-2.5-4.4a1.42 1.42 0 0 0-.93-.64.96.96 0 0 0-.75.18c-.25.19-.4.42-.45.7l.05.05 2.35 4.13c1.62 2.95 1.1 5.78-1.52 8.4l-.46.41c1-.13 1.93-.6 2.78-1.45 2.7-2.7 2.51-5.59 1.43-7.38zM12.07 9.01c-.13-.69.08-1.3.57-1.77l-2.06-2.07a1.12 1.12 0 0 0-1.56 0c-.15.15-.22.34-.27.53L12.07 9z"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M14.74 8.3a1.13 1.13 0 0 0-.73-.5.67.67 0 0 0-.53.13c-.15.12-.59.46-.2 1.3l1.18 2.5a.45.45 0 0 1-.23.76.44.44 0 0 1-.48-.25L7.6 6.11a.82.82 0 1 0-1.15 1.15l3.64 3.64a.45.45 0 1 1-.63.63L5.83 7.9 4.8 6.86a.82.82 0 0 0-1.33.9c.04.1.1.18.18.26l1.02 1.03 3.65 3.64a.44.44 0 0 1-.15.73.44.44 0 0 1-.48-.1L4.05 9.68a.82.82 0 0 0-1.4.57.81.81 0 0 0 .24.58l1.53 1.54 2.3 2.28a.45.45 0 0 1-.64.63L3.8 13a.81.81 0 0 0-1.39.57c0 .22.09.43.24.58l4.4 4.4c2.8 2.8 5.5 4.12 8.68.94 2.27-2.28 2.71-4.6 1.34-7.1l-2.32-4.08z"></path></svg></div></div></div><div class="pw-multi-vote-count l lh li lj lk ll lm ln"><p class="be b du z dt"><span class="ky">--</span></p></div></div></span><span class="l h g f sk sl"><div class="ab q ks"><div class="pw-multi-vote-icon fg kt ku kv kw"><div class=""><div class="kx ky kz la lb lc ld am le lf lg kw"><svg width="24" height="24" viewBox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" clip-rule="evenodd" d="M11.37.83L12 3.28l.63-2.45h-1.26zM15.42 1.84l-1.18-.39-.34 2.5 1.52-2.1zM9.76 1.45l-1.19.4 1.53 2.1-.34-2.5zM20.25 11.84l-2.5-4.4a1.42 1.42 0 0 0-.93-.64.96.96 0 0 0-.75.18c-.25.19-.4.42-.45.7l.05.05 2.35 4.13c1.62 2.95 1.1 5.78-1.52 8.4l-.46.41c1-.13 1.93-.6 2.78-1.45 2.7-2.7 2.51-5.59 1.43-7.38zM12.07 9.01c-.13-.69.08-1.3.57-1.77l-2.06-2.07a1.12 1.12 0 0 0-1.56 0c-.15.15-.22.34-.27.53L12.07 9z"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M14.74 8.3a1.13 1.13 0 0 0-.73-.5.67.67 0 0 0-.53.13c-.15.12-.59.46-.2 1.3l1.18 2.5a.45.45 0 0 1-.23.76.44.44 0 0 1-.48-.25L7.6 6.11a.82.82 0 1 0-1.15 1.15l3.64 3.64a.45.45 0 1 1-.63.63L5.83 7.9 4.8 6.86a.82.82 0 0 0-1.33.9c.04.1.1.18.18.26l1.02 1.03 3.65 3.64a.44.44 0 0 1-.15.73.44.44 0 0 1-.48-.1L4.05 9.68a.82.82 0 0 0-1.4.57.81.81 0 0 0 .24.58l1.53 1.54 2.3 2.28a.45.45 0 0 1-.64.63L3.8 13a.81.81 0 0 0-1.39.57c0 .22.09.43.24.58l4.4 4.4c2.8 2.8 5.5 4.12 8.68.94 2.27-2.28 2.71-4.6 1.34-7.1l-2.32-4.08z"></path></svg></div></div></div><div class="pw-multi-vote-count l lh li lj lk ll lm ln"><p class="be b du z dt"><span class="ky">--</span></p></div></div></span></div><div class="bp ab"><div><div class="bl" aria-hidden="false"><button class="ao kx lo lp ab q fh lq lr" aria-label="responses"><svg width="24" height="24" viewBox="0 0 24 24" class="ls"><path d="M18 16.8a7.14 7.14 0 0 0 2.24-5.32c0-4.12-3.53-7.48-8.05-7.48C7.67 4 4 7.36 4 11.48c0 4.13 3.67 7.48 8.2 7.48a8.9 8.9 0 0 0 2.38-.32c.23.2.48.39.75.56 1.06.69 2.2 1.04 3.4 1.04.22 0 .4-.11.48-.29a.5.5 0 0 0-.04-.52 6.4 6.4 0 0 1-1.16-2.65v.02zm-3.12 1.06l-.06-.22-.32.1a8 8 0 0 1-2.3.33c-4.03 0-7.3-2.96-7.3-6.59S8.17 4.9 12.2 4.9c4 0 7.1 2.96 7.1 6.6 0 1.8-.6 3.47-2.02 4.72l-.2.16v.26l.02.3a6.74 6.74 0 0 0 .88 2.4 5.27 5.27 0 0 1-2.17-.86c-.28-.17-.72-.38-.94-.59l.01-.02z"></path></svg></button></div></div></div></div><div class="ab q"><div class="ph l jg"></div><div class="ph l jg"><div class="bl" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bl" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="footerSocialShareButton" class="af fh ah ai aj ak al mb an ao ap eu mc md lr me"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M15.22 4.93a.42.42 0 0 1-.12.13h.01a.45.45 0 0 1-.29.08.52.52 0 0 1-.3-.13L12.5 3v7.07a.5.5 0 0 1-.5.5.5.5 0 0 1-.5-.5V3.02l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.8a.42.42 0 0 1 .07.5zm-.1.14zm.88 2h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11a2 2 0 0 1-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.14c.1.1.15.22.15.35a.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9V8.96c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1z" fill="currentColor"></path></svg></button></div></div></div></div></div></div></div></div></div></footer><div class="sm sn so sp sq l bw"><div class="ab ca"><div class="ch bg fw fx fy fz"><div class="ck ab sr co"><div class="ab io"><a rel="noopener follow" href="/@fadop3?source=post_page-----74527886921c--------------------------------"><div class="l ss st bx su is"><div class="l fg"><img alt="Fabian Peschke" class="l fa bx sv sw cw" src="https://miro.medium.com/v2/resize:fill:144:144/1*KlSOTO9tp09aM_xvVkIJDQ@2x.jpeg" width="72" height="72" loading="lazy"/><div class="it bx l sv sw fp n iu fq"></div></div></div></a></div><div class="j i d"><div class="ab"><span><button class="be b bf z el rp em eo ep eq er es et eu ev ew ex sx ey ez fa bl fb fc">Follow</button></span><div class="ds l"><div><div><div class="bl" aria-hidden="false"><div class="l"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" rel="noopener follow" href="/m/signin?actionUrl=%2F_%2Fapi%2Fusers%2Fab00f83c5330%2Flazily-enable-writer-subscription&amp;operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2F%40fadop3%2Fnavigating-the-complexity-of-acquiring-multiple-resource-group-scopes-in-oauth-74527886921c&amp;user=Fabian+Peschke&amp;userId=ab00f83c5330&amp;source=-----74527886921c---------------------subscribe_user-----------"><button class="be b bf z tb am tc td te tf tg th ti tj et eu ev ew ex ey ez fa bl fb fc" aria-label="Subscribe"><svg width="38" height="38" viewBox="0 0 38 38" fill="none" class="sy sz ta"><rect x="26.25" y="9.25" width="0.5" height="6.5" rx="0.25"></rect><rect x="29.75" y="12.25" width="0.5" height="6.5" rx="0.25" transform="rotate(90 29.75 12.25)"></rect><path d="M19.5 12.5h-7a1 1 0 0 0-1 1v11a1 1 0 0 0 1 1h13a1 1 0 0 0 1-1v-5"></path><path d="M11.5 14.5L19 20l4-3"></path></svg></button></a></span></div></div></div></div></div></div></div></div><div class="ab cm co"><div class="l"><div class="ab q"><a class="af ag ah ai aj ak al am an ao ap aq ar as at ab q" rel="noopener follow" href="/@fadop3?source=post_page-----74527886921c--------------------------------"><h2 class="pw-author-name be tk tl tm tn bj"><span class="gk">Written by <!-- -->Fabian Peschke</span></h2></a></div><div class="rn ab"><div class="l jg"><span class="pw-follower-count be b bf z bj"><a class="af ag ah ai aj ak al am an ao ap aq ar iz" rel="noopener follow" href="/@fadop3/followers?source=post_page-----74527886921c--------------------------------">7 Followers</a></span></div></div><div class="to l"><p class="be b bf z bj"><span class="gk">Software developer @BASF. Data science and python</span></p></div></div><div class="h k"><div class="ab"><span><button class="be b bf z el rp em eo ep eq er es et eu ev ew ex sx ey ez fa bl fb fc">Follow</button></span><div class="ds l"><div><div><div class="bl" aria-hidden="false"><div class="l"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" rel="noopener follow" href="/m/signin?actionUrl=%2F_%2Fapi%2Fusers%2Fab00f83c5330%2Flazily-enable-writer-subscription&amp;operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2F%40fadop3%2Fnavigating-the-complexity-of-acquiring-multiple-resource-group-scopes-in-oauth-74527886921c&amp;user=Fabian+Peschke&amp;userId=ab00f83c5330&amp;source=-----74527886921c---------------------subscribe_user-----------"><button class="be b bf z tb am tc td te tf tg th ti tj et eu ev ew ex ey ez fa bl fb fc" aria-label="Subscribe"><svg width="38" height="38" viewBox="0 0 38 38" fill="none" class="sy sz ta"><rect x="26.25" y="9.25" width="0.5" height="6.5" rx="0.25"></rect><rect x="29.75" y="12.25" width="0.5" height="6.5" rx="0.25" transform="rotate(90 29.75 12.25)"></rect><path d="M19.5 12.5h-7a1 1 0 0 0-1 1v11a1 1 0 0 0 1 1h13a1 1 0 0 0 1-1v-5"></path><path d="M11.5 14.5L19 20l4-3"></path></svg></button></a></span></div></div></div></div></div></div></div></div><div class="tp bg tq tr ts tt tu tv"></div></div></div><div class="h k j"><div class="tp bg tq tw"></div><div class="ab ca"><div class="ch bg fw fx fy fz"><div class="tx ab ks jj"><div class="ty tz l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://help.medium.com/hc/en-us?source=post_page-----74527886921c--------------------------------" rel="noopener follow"><p class="be b du z dt">Help</p></a></div><div class="ty tz l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://medium.statuspage.io/?source=post_page-----74527886921c--------------------------------" rel="noopener follow"><p class="be b du z dt">Status</p></a></div><div class="ty tz l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" rel="noopener follow" href="/about?autoplay=1&amp;source=post_page-----74527886921c--------------------------------"><p class="be b du z dt">About</p></a></div><div class="ty tz l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" rel="noopener follow" href="/jobs-at-medium/work-at-medium-959d1a85284e?source=post_page-----74527886921c--------------------------------"><p class="be b du z dt">Careers</p></a></div><div class="ty tz l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://blog.medium.com/?source=post_page-----74527886921c--------------------------------" rel="noopener follow"><p class="be b du z dt">Blog</p></a></div><div class="ty tz l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----74527886921c--------------------------------" rel="noopener follow"><p class="be b du z dt">Privacy</p></a></div><div class="ty tz l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----74527886921c--------------------------------" rel="noopener follow"><p class="be b du z dt">Terms</p></a></div><div class="ty tz l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://speechify.com/medium?source=post_page-----74527886921c--------------------------------" rel="noopener follow"><p class="be b du z dt">Text to speech</p></a></div><div class="ty l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" rel="noopener follow" href="/business?source=post_page-----74527886921c--------------------------------"><p class="be b du z dt">Teams</p></a></div></div></div></div></div></div></div></div></div></div><script>window.__BUILD_ID__="main-20240209-151517-b067f7a874"</script><script>window.__GRAPHQL_URI__ = "https://medium.com/_/graphql"</script><script>window.__PRELOADED_STATE__ = {"algolia":{"queries":{}},"cache":{"experimentGroupSet":true,"reason":"","group":"enabled","tags":["group-edgeCachePosts","post-74527886921c","user-ab00f83c5330"],"serverVariantState":"44136fa355b3678a1146ad16f7e8649e94fb4fc21fe77e8310c060f61caaff8a","middlewareEnabled":true,"cacheStatus":"DYNAMIC","shouldUseCache":true,"vary":[],"loHomepageEnabled":false,"loHomepage2Enabled":false},"client":{"hydrated":false,"isUs":false,"isNativeMedium":false,"isSafariMobile":false,"isSafari":false,"isFirefox":false,"routingEntity":{"type":"DEFAULT","explicit":false},"viewerIsBot":false},"debug":{"requestId":"f7722bf1-9490-4561-9aa6-8a0dc7a8f78f","hybridDevServices":[],"originalSpanCarrier":{"ot-tracer-spanid":"700f14d354006cb0","ot-tracer-traceid":"4096d9647d87f557","ot-tracer-sampled":"true"}},"multiVote":{"clapsPerPost":{}},"navigation":{"branch":{"show":null,"hasRendered":null,"blockedByCTA":false},"hideGoogleOneTap":false,"hasRenderedAlternateUserBanner":null,"currentLocation":"https:\u002F\u002Fmedium.com\u002F@fadop3\u002Fnavigating-the-complexity-of-acquiring-multiple-resource-group-scopes-in-oauth-74527886921c","host":"medium.com","hostname":"medium.com","referrer":"","hasSetReferrer":false,"susiModal":{"step":null,"operation":"register"},"postRead":false,"queryString":"","currentHash":""},"config":{"nodeEnv":"production","version":"main-20240209-151517-b067f7a874","target":"production","productName":"Medium","publicUrl":"https:\u002F\u002Fcdn-client.medium.com\u002Flite","authDomain":"medium.com","authGoogleClientId":"216296035834-k1k6qe060s2tp2a2jam4ljdcms00sttg.apps.googleusercontent.com","favicon":"production","glyphUrl":"https:\u002F\u002Fglyph.medium.com","branchKey":"key_live_ofxXr2qTrrU9NqURK8ZwEhknBxiI6KBm","algolia":{"appId":"MQ57UUUQZ2","apiKeySearch":"394474ced050e3911ae2249ecc774921","indexPrefix":"medium_","host":"-dsn.algolia.net"},"recaptchaKey":"6Lfc37IUAAAAAKGGtC6rLS13R1Hrw_BqADfS1LRk","recaptcha3Key":"6Lf8R9wUAAAAABMI_85Wb8melS7Zj6ziuf99Yot5","datadog":{"applicationId":"6702d87d-a7e0-42fe-bbcb-95b469547ea0","clientToken":"pub853ea8d17ad6821d9f8f11861d23dfed","rumToken":"pubf9cc52896502b9413b68ba36fc0c7162","context":{"deployment":{"target":"production","tag":"main-20240209-151517-b067f7a874","commit":"b067f7a87481188457fcec3dacea579867917991"}},"datacenter":"us"},"googleAnalyticsCode":"G-7JY7T788PK","googlePay":{"apiVersion":"2","apiVersionMinor":"0","merchantId":"BCR2DN6TV7EMTGBM","merchantName":"Medium","instanceMerchantId":"13685562959212738550"},"applePay":{"version":3},"signInWallCustomDomainCollectionIds":["3a8144eabfe3","336d898217ee","61061eb0c96b","138adf9c44c","819cc2aaeee0"],"mediumMastodonDomainName":"me.dm","mediumOwnedAndOperatedCollectionIds":["8a9336e5bb4","b7e45b22fec3","193b68bd4fba","8d6b8a439e32","54c98c43354d","3f6ecf56618","d944778ce714","92d2092dc598","ae2a65f35510","1285ba81cada","544c7006046e","fc8964313712","40187e704f1c","88d9857e584e","7b6769f2748b","bcc38c8f6edf","cef6983b292","cb8577c9149e","444d13b52878","713d7dbc99b0","ef8e90590e66","191186aaafa0","55760f21cdc5","9dc80918cc93","bdc4052bbdba","8ccfed20cbb2"],"tierOneDomains":["medium.com","thebolditalic.com","arcdigital.media","towardsdatascience.com","uxdesign.cc","codeburst.io","psiloveyou.xyz","writingcooperative.com","entrepreneurshandbook.co","prototypr.io","betterhumans.coach.me","theascent.pub"],"topicsToFollow":["d61cf867d93f","8a146bc21b28","1eca0103fff3","4d562ee63426","aef1078a3ef5","e15e46793f8d","6158eb913466","55f1c20aba7a","3d18b94f6858","4861fee224fd","63c6f1f93ee","1d98b3a9a871","decb52b64abf","ae5d4995e225","830cded25262"],"topicToTagMappings":{"accessibility":"accessibility","addiction":"addiction","android-development":"android-development","art":"art","artificial-intelligence":"artificial-intelligence","astrology":"astrology","basic-income":"basic-income","beauty":"beauty","biotech":"biotech","blockchain":"blockchain","books":"books","business":"business","cannabis":"cannabis","cities":"cities","climate-change":"climate-change","comics":"comics","coronavirus":"coronavirus","creativity":"creativity","cryptocurrency":"cryptocurrency","culture":"culture","cybersecurity":"cybersecurity","data-science":"data-science","design":"design","digital-life":"digital-life","disability":"disability","economy":"economy","education":"education","equality":"equality","family":"family","feminism":"feminism","fiction":"fiction","film":"film","fitness":"fitness","food":"food","freelancing":"freelancing","future":"future","gadgets":"gadgets","gaming":"gaming","gun-control":"gun-control","health":"health","history":"history","humor":"humor","immigration":"immigration","ios-development":"ios-development","javascript":"javascript","justice":"justice","language":"language","leadership":"leadership","lgbtqia":"lgbtqia","lifestyle":"lifestyle","machine-learning":"machine-learning","makers":"makers","marketing":"marketing","math":"math","media":"media","mental-health":"mental-health","mindfulness":"mindfulness","money":"money","music":"music","neuroscience":"neuroscience","nonfiction":"nonfiction","outdoors":"outdoors","parenting":"parenting","pets":"pets","philosophy":"philosophy","photography":"photography","podcasts":"podcast","poetry":"poetry","politics":"politics","privacy":"privacy","product-management":"product-management","productivity":"productivity","programming":"programming","psychedelics":"psychedelics","psychology":"psychology","race":"race","relationships":"relationships","religion":"religion","remote-work":"remote-work","san-francisco":"san-francisco","science":"science","self":"self","self-driving-cars":"self-driving-cars","sexuality":"sexuality","social-media":"social-media","society":"society","software-engineering":"software-engineering","space":"space","spirituality":"spirituality","sports":"sports","startups":"startup","style":"style","technology":"technology","transportation":"transportation","travel":"travel","true-crime":"true-crime","tv":"tv","ux":"ux","venture-capital":"venture-capital","visual-design":"visual-design","work":"work","world":"world","writing":"writing"},"defaultImages":{"avatar":{"imageId":"1*dmbNkD5D-u45r44go_cf0g.png","height":150,"width":150},"orgLogo":{"imageId":"1*OMF3fSqH8t4xBJ9-6oZDZw.png","height":106,"width":545},"postLogo":{"imageId":"1*kFrc4tBFM_tCis-2Ic87WA.png","height":810,"width":1440},"postPreviewImage":{"imageId":"1*hn4v1tCaJy7cWMyb0bpNpQ.png","height":386,"width":579}},"collectionStructuredData":{"8d6b8a439e32":{"name":"Elemental","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F980\u002F1*9ygdqoKprhwuTVKUM0DLPA@2x.png","width":980,"height":159}}},"3f6ecf56618":{"name":"Forge","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F596\u002F1*uULpIlImcO5TDuBZ6lm7Lg@2x.png","width":596,"height":183}}},"ae2a65f35510":{"name":"GEN","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fmiro.medium.com\u002Fmax\u002F264\u002F1*RdVZMdvfV3YiZTw6mX7yWA.png","width":264,"height":140}}},"88d9857e584e":{"name":"LEVEL","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fmiro.medium.com\u002Fmax\u002F540\u002F1*JqYMhNX6KNNb2UlqGqO2WQ.png","width":540,"height":108}}},"7b6769f2748b":{"name":"Marker","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F383\u002F1*haCUs0wF6TgOOvfoY-jEoQ@2x.png","width":383,"height":92}}},"444d13b52878":{"name":"OneZero","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fmiro.medium.com\u002Fmax\u002F540\u002F1*cw32fIqCbRWzwJaoQw6BUg.png","width":540,"height":123}}},"8ccfed20cbb2":{"name":"Zora","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fmiro.medium.com\u002Fmax\u002F540\u002F1*tZUQqRcCCZDXjjiZ4bDvgQ.png","width":540,"height":106}}}},"embeddedPostIds":{"coronavirus":"cd3010f9d81f"},"sharedCdcMessaging":{"COVID_APPLICABLE_TAG_SLUGS":[],"COVID_APPLICABLE_TOPIC_NAMES":[],"COVID_APPLICABLE_TOPIC_NAMES_FOR_TOPIC_PAGE":[],"COVID_MESSAGES":{"tierA":{"text":"For more information on the novel coronavirus and Covid-19, visit cdc.gov.","markups":[{"start":66,"end":73,"href":"https:\u002F\u002Fwww.cdc.gov\u002Fcoronavirus\u002F2019-nCoV"}]},"tierB":{"text":"Anyone can publish on Medium per our Policies, but we don’t fact-check every story. For more info about the coronavirus, see cdc.gov.","markups":[{"start":37,"end":45,"href":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Fcategories\u002F201931128-Policies-Safety"},{"start":125,"end":132,"href":"https:\u002F\u002Fwww.cdc.gov\u002Fcoronavirus\u002F2019-nCoV"}]},"paywall":{"text":"This article has been made free for everyone, thanks to Medium Members. For more information on the novel coronavirus and Covid-19, visit cdc.gov.","markups":[{"start":56,"end":70,"href":"https:\u002F\u002Fmedium.com\u002Fmembership"},{"start":138,"end":145,"href":"https:\u002F\u002Fwww.cdc.gov\u002Fcoronavirus\u002F2019-nCoV"}]},"unbound":{"text":"This article is free for everyone, thanks to Medium Members. For more information on the novel coronavirus and Covid-19, visit cdc.gov.","markups":[{"start":45,"end":59,"href":"https:\u002F\u002Fmedium.com\u002Fmembership"},{"start":127,"end":134,"href":"https:\u002F\u002Fwww.cdc.gov\u002Fcoronavirus\u002F2019-nCoV"}]}},"COVID_BANNER_POST_ID_OVERRIDE_WHITELIST":["3b31a67bff4a"]},"sharedVoteMessaging":{"TAGS":["politics","election-2020","government","us-politics","election","2020-presidential-race","trump","donald-trump","democrats","republicans","congress","republican-party","democratic-party","biden","joe-biden","maga"],"TOPICS":["politics","election"],"MESSAGE":{"text":"Find out more about the U.S. election results here.","markups":[{"start":46,"end":50,"href":"https:\u002F\u002Fcookpolitical.com\u002F2020-national-popular-vote-tracker"}]},"EXCLUDE_POSTS":["397ef29e3ca5"]},"embedPostRules":[],"recircOptions":{"v1":{"limit":3},"v2":{"limit":8}},"braintreeClientKey":"production_zjkj96jm_m56f8fqpf7ngnrd4","braintree":{"enabled":true,"merchantId":"m56f8fqpf7ngnrd4","merchantAccountId":{"usd":"AMediumCorporation_instant","eur":"amediumcorporation_EUR","cad":"amediumcorporation_CAD"},"publicKey":"ds2nn34bg2z7j5gd","braintreeEnvironment":"production","dashboardUrl":"https:\u002F\u002Fwww.braintreegateway.com\u002Fmerchants","gracePeriodDurationInDays":14,"mediumMembershipPlanId":{"monthly":"ce105f8c57a3","monthlyWithTrial":"d5ee3dbe3db8","monthlyPremium":"fa741a9b47a2","yearly":"a40ad4a43185","yearlyStaff":"d74fb811198a","yearlyWithTrial":"b3bc7350e5c7","yearlyPremium":"e21bd2c12166","monthlyCad":"p52orjkaceei","yearlyCad":"h4q9g2up9ktt"},"braintreeDiscountId":{"oneMonthFree":"MONTHS_FREE_01","threeMonthsFree":"MONTHS_FREE_03","sixMonthsFree":"MONTHS_FREE_06","fiftyPercentOffOneYear":"FIFTY_PERCENT_OFF_ONE_YEAR"},"3DSecureVersion":"2","defaultCurrency":"usd","providerPlanIdCurrency":{"4ycw":"usd","rz3b":"usd","3kqm":"usd","jzw6":"usd","c2q2":"usd","nnsw":"usd","q8qw":"usd","d9y6":"usd","fx7w":"cad","nwf2":"cad"}},"paypalClientId":"AXj1G4fotC2GE8KzWX9mSxCH1wmPE3nJglf4Z2ig_amnhvlMVX87otaq58niAg9iuLktVNF_1WCMnN7v","paypal":{"host":"https:\u002F\u002Fapi.paypal.com:443","clientMode":"production","serverMode":"live","webhookId":"4G466076A0294510S","monthlyPlan":{"planId":"P-9WR0658853113943TMU5FDQA","name":"Medium Membership (Monthly) with setup fee","description":"Unlimited access to the best and brightest stories on Medium. Membership billed monthly."},"yearlyPlan":{"planId":"P-7N8963881P8875835MU5JOPQ","name":"Medium Membership (Annual) with setup fee","description":"Unlimited access to the best and brightest stories on Medium. Membership billed annually."},"oneYearGift":{"name":"Medium Membership (1 Year, Digital Gift Code)","description":"Unlimited access to the best and brightest stories on Medium. Gift codes can be redeemed at medium.com\u002Fredeem.","price":"50.00","currency":"USD","sku":"membership-gift-1-yr"},"oldMonthlyPlan":{"planId":"P-96U02458LM656772MJZUVH2Y","name":"Medium Membership (Monthly)","description":"Unlimited access to the best and brightest stories on Medium. Membership billed monthly."},"oldYearlyPlan":{"planId":"P-59P80963JF186412JJZU3SMI","name":"Medium Membership (Annual)","description":"Unlimited access to the best and brightest stories on Medium. Membership billed annually."},"monthlyPlanWithTrial":{"planId":"P-66C21969LR178604GJPVKUKY","name":"Medium Membership (Monthly) with setup fee","description":"Unlimited access to the best and brightest stories on Medium. Membership billed monthly."},"yearlyPlanWithTrial":{"planId":"P-6XW32684EX226940VKCT2MFA","name":"Medium Membership (Annual) with setup fee","description":"Unlimited access to the best and brightest stories on Medium. Membership billed annually."},"oldMonthlyPlanNoSetupFee":{"planId":"P-4N046520HR188054PCJC7LJI","name":"Medium Membership (Monthly)","description":"Unlimited access to the best and brightest stories on Medium. Membership billed monthly."},"oldYearlyPlanNoSetupFee":{"planId":"P-7A4913502Y5181304CJEJMXQ","name":"Medium Membership (Annual)","description":"Unlimited access to the best and brightest stories on Medium. Membership billed annually."},"sdkUrl":"https:\u002F\u002Fwww.paypal.com\u002Fsdk\u002Fjs"},"stripePublishableKey":"pk_live_7FReX44VnNIInZwrIIx6ghjl","log":{"json":true,"level":"info"},"imageUploadMaxSizeMb":25,"staffPicks":{"title":"Staff Picks","catalogId":"c7bc6e1ee00f"}},"session":{"xsrf":""}}</script><script>window.__APOLLO_STATE__ = {"ROOT_QUERY":{"__typename":"Query","viewer":null,"isLoggedIn":false,"collectionByDomainOrSlug({\"domainOrSlug\":\"medium.com\"})":null,"postResult({\"id\":\"74527886921c\"})":{"__ref":"Post:74527886921c"}},"LinkedAccounts:ab00f83c5330":{"__typename":"LinkedAccounts","mastodon":null,"id":"ab00f83c5330"},"UserViewerEdge:userId:ab00f83c5330-viewerId:lo_8215b72092f0":{"__typename":"UserViewerEdge","id":"userId:ab00f83c5330-viewerId:lo_8215b72092f0","isFollowing":false,"isUser":false},"User:ab00f83c5330":{"__typename":"User","id":"ab00f83c5330","linkedAccounts":{"__ref":"LinkedAccounts:ab00f83c5330"},"isSuspended":false,"imageId":"1*KlSOTO9tp09aM_xvVkIJDQ@2x.jpeg","mediumMemberAt":1670195599000,"verifications":{"__typename":"VerifiedInfo","isBookAuthor":false},"name":"Fabian Peschke","socialStats":{"__typename":"SocialStats","followerCount":7},"username":"fadop3","customDomainState":null,"hasSubdomain":false,"bio":"Software developer @BASF. Data science and python","isPartnerProgramEnrolled":false,"viewerEdge":{"__ref":"UserViewerEdge:userId:ab00f83c5330-viewerId:lo_8215b72092f0"},"viewerIsUser":false,"newsletterV3":null,"postSubscribeMembershipUpsellShownAt":0,"allowNotes":true,"membership":{"__ref":"Membership:5ea728329a22"},"twitterScreenName":""},"Paragraph:2e188b7fe0e1_0":{"__typename":"Paragraph","id":"2e188b7fe0e1_0","name":"5313","type":"H3","href":null,"layout":null,"metadata":null,"text":"Navigating the Complexity of Acquiring Multiple Resource Group Scopes in OAuth","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_1":{"__typename":"Paragraph","id":"2e188b7fe0e1_1","name":"e51a","type":"H4","href":null,"layout":null,"metadata":null,"text":"Multi scope token authentication in Microsoft Entra ID","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*ytetQ6n7dB1Sm8e_wbcPBw.png":{"__typename":"ImageMetadata","id":"1*ytetQ6n7dB1Sm8e_wbcPBw.png","originalHeight":1024,"originalWidth":1024,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:2e188b7fe0e1_2":{"__typename":"Paragraph","id":"2e188b7fe0e1_2","name":"22b5","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*ytetQ6n7dB1Sm8e_wbcPBw.png"},"text":"Picture generated by Dall-e","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_3":{"__typename":"Paragraph","id":"2e188b7fe0e1_3","name":"6e74","type":"H4","href":null,"layout":null,"metadata":null,"text":"Multi scope authentication using Microsoft Entra ID","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_4":{"__typename":"Paragraph","id":"2e188b7fe0e1_4","name":"aaed","type":"P","href":null,"layout":null,"metadata":null,"text":"OAuth 2.0 is a key technology in web development, especially when it comes to login and permissions. It allows apps to get limited access to user accounts on services like Facebook, Google, GitHub, and Microsoft, using HTTP requests. Managing access to different types of user data or actions (known as “scopes”) within OAuth is a challenging task for developers. This is tricky because each service (like Facebook or Microsoft) has its own set of rules for access, and giving access too broadly can lead to security issues.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_5":{"__typename":"Paragraph","id":"2e188b7fe0e1_5","name":"0519","type":"H3","href":null,"layout":null,"metadata":null,"text":"Understanding the Challenge","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_6":{"__typename":"Paragraph","id":"2e188b7fe0e1_6","name":"123b","type":"P","href":null,"layout":null,"metadata":null,"text":"A resource scope, in OAuth terms, is a permission that defines the extent of access that an application can have on a user’s account. In simple scenarios, where an app requires access to a single type of resource, managing scopes is fairly straightforward. However, complications arise when an application needs to interact with multiple resource groups, each requiring different scopes of access.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_7":{"__typename":"Paragraph","id":"2e188b7fe0e1_7","name":"399a","type":"P","href":null,"layout":null,"metadata":null,"text":"Consider an application that requires access to both a user’s Microsoft Graph data and specific Azure Blob Storage resources. Each of these resources has its own set of scopes, and obtaining consent for each, especially in a user-friendly and secure manner, can be challenging. The key difficulties include:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_8":{"__typename":"Paragraph","id":"2e188b7fe0e1_8","name":"12af","type":"OLI","href":null,"layout":null,"metadata":null,"text":"User Experience: Ensuring that the user understands what permissions they are granting and why they are necessary without having to authorize multiple times.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_9":{"__typename":"Paragraph","id":"2e188b7fe0e1_9","name":"6061","type":"OLI","href":null,"layout":null,"metadata":null,"text":"Security: Limiting the scopes to the minimum required, thereby adhering to the principle of least privilege.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_10":{"__typename":"Paragraph","id":"2e188b7fe0e1_10","name":"aafd","type":"OLI","href":null,"layout":null,"metadata":null,"text":"Technical Complexity: Handling multiple redirects, tokens, and potential consent screens in a seamless workflow.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_11":{"__typename":"Paragraph","id":"2e188b7fe0e1_11","name":"2db1","type":"H3","href":null,"layout":null,"metadata":null,"text":"Prerequisites","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_12":{"__typename":"Paragraph","id":"2e188b7fe0e1_12","name":"72bd","type":"ULI","href":null,"layout":null,"metadata":null,"text":"Microsoft Azure Subscription","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":0,"end":28,"href":"https:\u002F\u002Fazure.microsoft.com\u002Fde-de\u002Ffree\u002Fsearch\u002F?ef_id=_k_Cj0KCQiAtOmsBhCnARIsAGPa5ybZ9JNjx9iIVRNiAijVxye52TuOWcBghfIqLErKN9U36ED3GtRqdNIaAhIzEALw_wcB_k_&OCID=AIDcmmzzaokddl_SEM__k_Cj0KCQiAtOmsBhCnARIsAGPa5ybZ9JNjx9iIVRNiAijVxye52TuOWcBghfIqLErKN9U36ED3GtRqdNIaAhIzEALw_wcB_k_&gad_source=1&gclid=Cj0KCQiAtOmsBhCnARIsAGPa5ybZ9JNjx9iIVRNiAijVxye52TuOWcBghfIqLErKN9U36ED3GtRqdNIaAhIzEALw_wcB","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_13":{"__typename":"Paragraph","id":"2e188b7fe0e1_13","name":"6173","type":"ULI","href":null,"layout":null,"metadata":null,"text":"Python knowledge","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_14":{"__typename":"Paragraph","id":"2e188b7fe0e1_14","name":"7d00","type":"H3","href":null,"layout":null,"metadata":null,"text":"Implementation","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_15":{"__typename":"Paragraph","id":"2e188b7fe0e1_15","name":"f4a5","type":"P","href":null,"layout":null,"metadata":null,"text":"The implementation can be found here. It uses FastApi both as backend and also to serve the HTML\u002F Javascript to the user for simplicity.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":32,"end":36,"href":"https:\u002F\u002Fgithub.com\u002FFadope1\u002FMultiScopeAuth","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_16":{"__typename":"Paragraph","id":"2e188b7fe0e1_16","name":"59bf","type":"H4","href":null,"layout":null,"metadata":null,"text":"Azure Setup","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_17":{"__typename":"Paragraph","id":"2e188b7fe0e1_17","name":"30e3","type":"P","href":null,"layout":null,"metadata":null,"text":"We will be using Azure to setup Entra ID for the authentication. Here you could also add different OAuth Providers like Google, Apple, Github…","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_18":{"__typename":"Paragraph","id":"2e188b7fe0e1_18","name":"663d","type":"P","href":null,"layout":null,"metadata":null,"text":"Creating the app registration.\nTo setup the app registration on Azure go to “Microsoft Entra ID\u003EApp registration\u003Enew registration”.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":0,"end":31,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*eYPCng-S_jhaAOEDVMxMvg.png":{"__typename":"ImageMetadata","id":"1*eYPCng-S_jhaAOEDVMxMvg.png","originalHeight":1096,"originalWidth":1614,"focusPercentX":null,"focusPercentY":null,"alt":"A picture showing the 3 steps to creating a new app registration. 1. Go to portal.azure.com the to the ms entra id tab. 2. Click on app registration. 3. Click on new app registration."},"Paragraph:2e188b7fe0e1_19":{"__typename":"Paragraph","id":"2e188b7fe0e1_19","name":"8500","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*eYPCng-S_jhaAOEDVMxMvg.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_20":{"__typename":"Paragraph","id":"2e188b7fe0e1_20","name":"2ceb","type":"P","href":null,"layout":null,"metadata":null,"text":"Adding redirect URI as web app.\nNow we need to fill in some information needed for the app registration. We need to give it a suitable name, which would ideally be a name similar to you project name. We need to also set a redirect uri. This URI needs to be of type Web for our case. Here we can define the allowed redirect URI that Microsoft will redirect the authentication back after the flow has finished. Regardless if it finished with errors or not. For now we will set it to localhost only. The endpoint will be implemented later on.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":0,"end":32,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*gXW6KEOgcy-TZ4ABrCNoOQ.png":{"__typename":"ImageMetadata","id":"1*gXW6KEOgcy-TZ4ABrCNoOQ.png","originalHeight":880,"originalWidth":1374,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:2e188b7fe0e1_21":{"__typename":"Paragraph","id":"2e188b7fe0e1_21","name":"1037","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*gXW6KEOgcy-TZ4ABrCNoOQ.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_22":{"__typename":"Paragraph","id":"2e188b7fe0e1_22","name":"66c4","type":"P","href":null,"layout":null,"metadata":null,"text":"Create secret for the app registration.\nTo access this app registration via the api we need to have a secret. This can be created by going under “your-app-registration\u003ECertificates & secrets\u003ENew client secret”","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":0,"end":40,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*xD_i6AGYN1di5-XQszphDg.png":{"__typename":"ImageMetadata","id":"1*xD_i6AGYN1di5-XQszphDg.png","originalHeight":880,"originalWidth":1374,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:2e188b7fe0e1_23":{"__typename":"Paragraph","id":"2e188b7fe0e1_23","name":"b875","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*xD_i6AGYN1di5-XQszphDg.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_24":{"__typename":"Paragraph","id":"2e188b7fe0e1_24","name":"9333","type":"P","href":null,"layout":null,"metadata":null,"text":"After giving the secret an appropriate name and expiration date copy the secret. We will be using a “.env” file to store our secrets locally. So go ahead and create a new folder with a “.env” file and put “CLIENT_SECRET=\u003Cyour-secret\u003E” into the file. Also head over to your app registration overview and copy the tenant id and client id and put it inside your “.env” file with naming:\nTENANT_ID=\u003Cyour-tenant-id\u003E\nCLIENT_ID=\u003Cyour-tenant-id\u003E","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_25":{"__typename":"Paragraph","id":"2e188b7fe0e1_25","name":"fb18","type":"P","href":null,"layout":null,"metadata":null,"text":"Also add a variable called BASE_URL to make your final “.env“ file look like this:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_26":{"__typename":"Paragraph","id":"2e188b7fe0e1_26","name":"e1cf","type":"PRE","href":null,"layout":null,"metadata":null,"text":"CLIENT_SECRET=dawdj9823d293hdd28u3d92u3d8u\nTENANT_ID=myidvalue239i10ojdodwad\nCLIENT_ID=myotheridvaluedj289dh2983h\nBASE_URL=http:\u002F\u002Flocalhost:8080","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"AUTO","lang":"ini"},"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_27":{"__typename":"Paragraph","id":"2e188b7fe0e1_27","name":"d360","type":"P","href":null,"layout":null,"metadata":null,"text":"Add app scopes\nAs the last step lets add all our scopes that the app will be using. Go to the app registration under “API permission” and create “Add a permission”. Then simply select the scopes needed for your app.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":0,"end":15,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*xoNM0XB_ak_rRp4xPhnVFQ.png":{"__typename":"ImageMetadata","id":"1*xoNM0XB_ak_rRp4xPhnVFQ.png","originalHeight":454,"originalWidth":1248,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:2e188b7fe0e1_28":{"__typename":"Paragraph","id":"2e188b7fe0e1_28","name":"4ddb","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*xoNM0XB_ak_rRp4xPhnVFQ.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_29":{"__typename":"Paragraph","id":"2e188b7fe0e1_29","name":"2918","type":"P","href":null,"layout":null,"metadata":null,"text":"Now Azure is successfully configured so lets start by implementing our frontend.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_30":{"__typename":"Paragraph","id":"2e188b7fe0e1_30","name":"ba10","type":"H4","href":null,"layout":null,"metadata":null,"text":"Frontend Workflow","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_31":{"__typename":"Paragraph","id":"2e188b7fe0e1_31","name":"4bc5","type":"P","href":null,"layout":null,"metadata":null,"text":"The authentication has 3 stages:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_32":{"__typename":"Paragraph","id":"2e188b7fe0e1_32","name":"3924","type":"ULI","href":null,"layout":null,"metadata":null,"text":"Silent Login: Happens when the user opens the website and initiates an OAuth flow without user interaction to check if the user is already authenticated and has the necessary permissions.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_33":{"__typename":"Paragraph","id":"2e188b7fe0e1_33","name":"cee8","type":"ULI","href":null,"layout":null,"metadata":null,"text":"Regular Login: Redirects to a login page, indicating that user interaction is required.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_34":{"__typename":"Paragraph","id":"2e188b7fe0e1_34","name":"5163","type":"ULI","href":null,"layout":null,"metadata":null,"text":"Consent and Token Acquisition: If additional consent is needed for new scopes, the user is redirected to a consent page.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_35":{"__typename":"Paragraph","id":"2e188b7fe0e1_35","name":"ed5b","type":"P","href":null,"layout":null,"metadata":null,"text":"These stages interact with each other like so:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*KwI4TqbYQreyLFc70pWZbg.jpeg":{"__typename":"ImageMetadata","id":"1*KwI4TqbYQreyLFc70pWZbg.jpeg","originalHeight":676,"originalWidth":847,"focusPercentX":null,"focusPercentY":null,"alt":"A triangle picture showing the connection between all 3 stages explained before."},"Paragraph:2e188b7fe0e1_36":{"__typename":"Paragraph","id":"2e188b7fe0e1_36","name":"6530","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*KwI4TqbYQreyLFc70pWZbg.jpeg"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_37":{"__typename":"Paragraph","id":"2e188b7fe0e1_37","name":"7520","type":"P","href":null,"layout":null,"metadata":null,"text":"To implement this we will be creating a simple HTML site. This site will be rendered by FastApi when the user is not authenticated yet.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_38":{"__typename":"Paragraph","id":"2e188b7fe0e1_38","name":"5c4f","type":"PRE","href":null,"layout":null,"metadata":null,"text":"\u003C!DOCTYPE html\u003E\n\u003Chtml\u003E\n    \u003Chead\u003E\n        \u003Ctitle\u003EAuth required\u003C\u002Ftitle\u003E\n    \u003C\u002Fhead\u003E\n    \u003Cbody\u003E\n        \u003Ch1\u003ENot authorized\u003C\u002Fh1\u003E\n        \u003Cp\u003EPlease authorize by signing in using an MS account\u003C\u002Fp\u003E\n        \u003Cbutton onclick=\"login()\"\u003EAuthorize\u003C\u002Fbutton\u003E\n    \u003C\u002Fbody\u003E\n\u003C\u002Fhtml\u003E","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"AUTO","lang":"xml"},"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_39":{"__typename":"Paragraph","id":"2e188b7fe0e1_39","name":"bccc","type":"P","href":null,"layout":null,"metadata":null,"text":"Lets also create a different HTML file that get displayed only when the user is authenticated.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_40":{"__typename":"Paragraph","id":"2e188b7fe0e1_40","name":"928d","type":"PRE","href":null,"layout":null,"metadata":null,"text":"\u003C!DOCTYPE html\u003E\n\u003Chtml\u003E\n    \u003Chead\u003E\n        \u003Ctitle\u003ESign In Successful\u003C\u002Ftitle\u003E\n    \u003C\u002Fhead\u003E\n    \u003Cbody\u003E\n        \u003Ch1\u003ESign In Successful\u003C\u002Fh1\u003E\n        \u003Cp\u003EWelcome! You have successfully signed in.\u003C\u002Fp\u003E\n    \u003C\u002Fbody\u003E\n\u003C\u002Fhtml\u003E","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"AUTO","lang":"xml"},"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_41":{"__typename":"Paragraph","id":"2e188b7fe0e1_41","name":"5eff","type":"P","href":null,"layout":null,"metadata":null,"text":"Lets start to create the actual endpoints.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_42":{"__typename":"Paragraph","id":"2e188b7fe0e1_42","name":"b879","type":"H4","href":null,"layout":null,"metadata":null,"text":"Backend Implementation","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_43":{"__typename":"Paragraph","id":"2e188b7fe0e1_43","name":"5bbd","type":"P","href":null,"layout":null,"metadata":null,"text":"This implementation requires some components:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_44":{"__typename":"Paragraph","id":"2e188b7fe0e1_44","name":"f3d0","type":"ULI","href":null,"layout":null,"metadata":null,"text":"OAuth Endpoints: Different FastAPI endpoints (\u002Fsilent_login, \u002Flogin, \u002Fconsent) handle various stages of the OAuth flow.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":46,"end":59,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":61,"end":67,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":69,"end":77,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_45":{"__typename":"Paragraph","id":"2e188b7fe0e1_45","name":"c9e7","type":"ULI","href":null,"layout":null,"metadata":null,"text":"Token Acquisition: Upon successful authentication and consent, the app exchanges the authorization code for access tokens.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_46":{"__typename":"Paragraph","id":"2e188b7fe0e1_46","name":"4610","type":"ULI","href":null,"layout":null,"metadata":null,"text":"Scope Management: The backend is designed to handle both default and additional scopes, ensuring that the application requests only the necessary permissions. The scopes needed to be added beforehand. But its easy to add new scopes when first authorization has passed.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_47":{"__typename":"Paragraph","id":"2e188b7fe0e1_47","name":"8d9c","type":"ULI","href":null,"layout":null,"metadata":null,"text":"Endpoints to render the frontend HTML.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_48":{"__typename":"Paragraph","id":"2e188b7fe0e1_48","name":"b551","type":"P","href":null,"layout":null,"metadata":null,"text":"Single scope authentication\nLets first create a simple endpoint to display our HTML:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":0,"end":28,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_49":{"__typename":"Paragraph","id":"2e188b7fe0e1_49","name":"a4ec","type":"PRE","href":null,"layout":null,"metadata":null,"text":"from fastapi import APIRouter, Request, Response\nfrom fastapi.templating import Jinja2Templates\n\nrouter = APIRouter()\ntemplates = Jinja2Templates(directory=\"frontend\u002Ftemplates\")  # Ensure you have a 'templates' directory\n\n\ndef check_authorization(request: Request) -\u003E bool:\n    return True\n\n\n@router.get(\"\u002F\")\nasync def home(request: Request, error: str | None=None) -\u003E Response:\n    if check_authorization(request) is True:\n        return templates.TemplateResponse(\"home.html\", {\"request\": request})\n    else:\n        return templates.TemplateResponse(\"unauthorized.html\", {\"request\": request})","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"EXPLICIT","lang":"python"},"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_50":{"__typename":"Paragraph","id":"2e188b7fe0e1_50","name":"28bc","type":"P","href":null,"layout":null,"metadata":null,"text":"For now the authentication is simply set to True, meaning the user is always authenticated. With this we can easily switch it to False to test if our Frontend is working.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_51":{"__typename":"Paragraph","id":"2e188b7fe0e1_51","name":"55d7","type":"P","href":null,"layout":null,"metadata":null,"text":"The next step is to implement a simple user session to store data between requests. This is needed to generate a code verifier to use again in the callback endpoint. Lets implement a simple user session that is stored in memory.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_52":{"__typename":"Paragraph","id":"2e188b7fe0e1_52","name":"c88a","type":"PRE","href":null,"layout":null,"metadata":null,"text":"from dotenv import load_dotenv\nload_dotenv(\"..\u002F.env\")\n\nfrom typing import Callable\nimport uuid\n\nfrom fastapi import FastAPI, Request\n\napp = FastAPI(\n    title=\"Test multi scope api\",\n    debug=__debug__,\n    docs_url=\"\u002Fapi\u002Fdocs\",\n    redoc_url=\"\u002Fapi\u002Fredoc\"\n)\n\nsession_store = {}\n\n\n@app.middleware(\"http\")\nasync def session_middleware(request: Request, call_next: Callable):\n    \"\"\"Add basic user session to request\"\"\"\n    session_id = request.cookies.get(\"session_id\", None)\n    if session_id not in session_store:\n        session_id = str(uuid.uuid4())\n        session_store[session_id] = {}\n\n    request.state.session = session_store[session_id]\n\n    response = await call_next(request)\n\n    response.set_cookie(key=\"session_id\", value=session_id)\n    return response","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"AUTO","lang":"python"},"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_53":{"__typename":"Paragraph","id":"2e188b7fe0e1_53","name":"1c53","type":"P","href":null,"layout":null,"metadata":null,"text":"Keep in mind that in a productive system this needs to be replaced by a correct implementation using encryption and a better way of storing the data.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_54":{"__typename":"Paragraph","id":"2e188b7fe0e1_54","name":"f889","type":"P","href":null,"layout":null,"metadata":null,"text":"Next we create the OAuth endpoints. The OAuth router is under “api\u002Fv1\u002Fauth\u002Foauth”. The whole structure can be found here.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":116,"end":120,"href":"https:\u002F\u002Fgithub.com\u002FFadope1\u002FMultiScopeAuth","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_55":{"__typename":"Paragraph","id":"2e188b7fe0e1_55","name":"9c6a","type":"P","href":null,"layout":null,"metadata":null,"text":"Lets start by implementing simple authentication endpoints.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_56":{"__typename":"Paragraph","id":"2e188b7fe0e1_56","name":"fe3d","type":"PRE","href":null,"layout":null,"metadata":null,"text":"import requests\nimport hashlib\nimport base64\nimport os\n\nfrom fastapi import APIRouter, Request\nfrom fastapi.responses import RedirectResponse\n\nrouter = APIRouter()\n\nclient_secret = os.getenv(\"CLIENT_SECRET\")\nclient_id = os.getenv(\"CLIENT_ID\")\ntenant_id = os.getenv(\"TENANT_ID\")\nbase_url = os.getenv(\"BASE_URL\")\nBASE_AUTH_URL = f\"https:\u002F\u002Flogin.microsoftonline.com\u002F{tenant_id}\u002Foauth2\u002Fv2.0\"\n\nDEFAULT_SCOPE = \"https:\u002F\u002Fgraph.microsoft.com\u002FUser.Read\"\n\n\n@router.get(\"\u002Flogin\")\nasync def login(request: Request, scope: str=DEFAULT_SCOPE):\n    code_verifier = base64.urlsafe_b64encode(os.urandom(40)).decode('utf-8').rstrip('=')\n    code_challenge = base64.urlsafe_b64encode(\n        hashlib.sha256(code_verifier.encode()).digest()\n    ).decode('utf-8').rstrip('=')\n\n    request.state.session['code_verifier'] = code_verifier\n\n    params = {\n        \"client_id\": client_id,\n        \"response_type\": \"code\",\n        \"redirect_uri\": f\"{base_url}\u002Fapi\u002Fv1\u002Fauth\u002Foauth\u002Fcallback\",\n        \"response_mode\": \"query\",\n        \"scope\": scope,\n        \"code_challenge\": code_challenge,\n        \"code_challenge_method\": \"S256\"\n    }\n    login_url = f\"{BASE_AUTH_URL}\u002Fauthorize?\" + \"&\".join([f\"{k}={v}\" for k, v in params.items()])\n    return RedirectResponse(url=login_url)\n\n\n@router.get(\"\u002Fcallback\")\nasync def callback(\n        request: Request,\n        code: str | None=None,\n        session_state: str | None=None,\n        error: str=None,\n        error_subcode: str=None,\n        error_description: str=None\n    ) -\u003E RedirectResponse:\n    code_verifier: str = request.state.session.get('code_verifier')\n    scope: str = request.state.session['scope'].split(\" \")[0]\n\n    url = f\"{BASE_AUTH_URL}\u002Ftoken\"\n    payload = {\n        \"grant_type\": \"authorization_code\",\n        \"client_id\": client_id,\n        \"client_secret\": client_secret,\n        \"scope\": scope,\n        \"code\": code,\n        \"redirect_uri\": f\"{base_url}\u002Fapi\u002Fv1\u002Fauth\u002Foauth\u002Fcallback\",\n        \"code_verifier\": code_verifier\n    }\n    response = requests.post(url, data=payload)\n    response.raise_for_status()\n    \n    data = response.json()\n    request.state.session[DEFAULT_SCOPE] = data[\"access_token\"]\n\n    return RedirectResponse(url=base_url) # go back to the homepage","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"EXPLICIT","lang":"python"},"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_57":{"__typename":"Paragraph","id":"2e188b7fe0e1_57","name":"f949","type":"P","href":null,"layout":null,"metadata":null,"text":"This API will authenticate against a single scope and after the process is done it will redirect to the homepage. To implement the authentication in the frontend lets change the Frontend API to dynamically display different HTML sites based on authentication:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_58":{"__typename":"Paragraph","id":"2e188b7fe0e1_58","name":"4d64","type":"PRE","href":null,"layout":null,"metadata":null,"text":"def check_authorization(request: Request) -\u003E bool:\n    return \"https:\u002F\u002Fgraph.microsoft.com\u002FUser.Read\" in request.state.session\n\n\n@router.get(\"\u002F\")\nasync def home(request: Request, error: str | None=None) -\u003E Response:\n    if check_authorization(request) is True:\n        return templates.TemplateResponse(\"home.html\", {\"request\": request})\n    else:\n        return templates.TemplateResponse(\"unauthorized.html\", {\"request\": request})","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"EXPLICIT","lang":"python"},"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_59":{"__typename":"Paragraph","id":"2e188b7fe0e1_59","name":"2c6b","type":"P","href":null,"layout":null,"metadata":null,"text":"Also add the required script to the HTML site to start authentication on button press.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_60":{"__typename":"Paragraph","id":"2e188b7fe0e1_60","name":"f92e","type":"PRE","href":null,"layout":null,"metadata":null,"text":"\u003Cscript\u003E\n  function login() {\n      regularLogin();\n  }\n\n  function regularLogin() {\n      \u002F\u002F Regular login process\n      window.location.href = '\u002Fapi\u002Fv1\u002Fauth\u002Foauth\u002Flogin';\n  }\n\u003C\u002Fscript\u003E","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"AUTO","lang":"xml"},"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_61":{"__typename":"Paragraph","id":"2e188b7fe0e1_61","name":"2f10","type":"P","href":null,"layout":null,"metadata":null,"text":"This will now check if the authentication was successful and the scope is set inside the user session.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_62":{"__typename":"Paragraph","id":"2e188b7fe0e1_62","name":"820d","type":"P","href":null,"layout":null,"metadata":null,"text":"Multi scope authentication\nThe key to acquiring multiple tokens for multiple scopes is to add “offline_ access” to the initial scope separated with spaces. This will add a refresh token to the response that can be used to claim different scopes. This is all you need for getting a new token using a refresh token:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":0,"end":27,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_63":{"__typename":"Paragraph","id":"2e188b7fe0e1_63","name":"1cf4","type":"PRE","href":null,"layout":null,"metadata":null,"text":"url = f\"{BASE_AUTH_URL}\u002Ftoken\"\npayload = {\n    \"grant_type\": \"refresh_token\", # set the grant_type to refresh_token\n    \"client_id\": client_id,\n    \"client_secret\": client_secret,\n    \"refresh_token\": refresh_token,\n    \"scope\": new_scope\n}\nresponse = requests.post(url, data=payload)\nresponse.raise_for_status()\ndata = response.json()\nnew_token = data[\"access_token\"]","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"EXPLICIT","lang":"python"},"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_64":{"__typename":"Paragraph","id":"2e188b7fe0e1_64","name":"9454","type":"P","href":null,"layout":null,"metadata":null,"text":"Lets also create two additional endpoints. One for trying to silently login and one for asking for consent for the user. This can be done by specifying the prompt perimeter when calling the OAuth API. The final code now looks like this:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_65":{"__typename":"Paragraph","id":"2e188b7fe0e1_65","name":"b12a","type":"PRE","href":null,"layout":null,"metadata":null,"text":"... # imports and basic config from before\n\nDEFAULT_SCOPE = \"https:\u002F\u002Fgraph.microsoft.com\u002FUser.Read\"\nADDITIONAL_SCOPES = \"https:\u002F\u002Fnewmultiscopetest.blob.core.windows.net\u002Fuser_impersonation\"\nALL_SCOPES = DEFAULT_SCOPE + \" \" + ADDITIONAL_SCOPES\n\n\n@router.get(\"\u002Fsilent_login\")\nasync def silent_login(request: Request, scope: str=DEFAULT_SCOPE):\n    code_verifier = base64.urlsafe_b64encode(os.urandom(40)).decode('utf-8').rstrip('=')\n    code_challenge = base64.urlsafe_b64encode(\n        hashlib.sha256(code_verifier.encode()).digest()\n    ).decode('utf-8').rstrip('=')\n\n    request.state.session['code_verifier'] = code_verifier\n    request.state.session['scope'] = scope\n    if \"offline_access\" not in scope:\n        scope += \" offline_access\"\n\n    params = {\n        \"client_id\": client_id,\n        \"response_type\": \"code\",\n        \"redirect_uri\": f\"{base_url}\u002Fapi\u002Fv1\u002Fauth\u002Foauth\u002Fcallback\",\n        \"response_mode\": \"query\",\n        \"scope\": scope,\n        \"prompt\": \"none\",\n        \"code_challenge\": code_challenge,\n        \"code_challenge_method\": \"S256\"\n    }\n    login_url = f\"{BASE_AUTH_URL}\u002Fauthorize?\" + \"&\".join([f\"{k}={v}\" for k, v in params.items()])\n    return RedirectResponse(url=login_url)\n\n\n@router.get(\"\u002Flogin\")\nasync def login(request: Request, scope: str=DEFAULT_SCOPE):\n    code_verifier = base64.urlsafe_b64encode(os.urandom(40)).decode('utf-8').rstrip('=')\n    code_challenge = base64.urlsafe_b64encode(\n        hashlib.sha256(code_verifier.encode()).digest()\n    ).decode('utf-8').rstrip('=')\n\n    request.state.session['code_verifier'] = code_verifier\n    request.state.session['scope'] = scope\n    if \"offline_access\" not in scope:\n        scope += \" offline_access\"\n\n    params = {\n        \"client_id\": client_id,\n        \"response_type\": \"code\",\n        \"redirect_uri\": f\"{base_url}\u002Fapi\u002Fv1\u002Fauth\u002Foauth\u002Fcallback\",\n        \"response_mode\": \"query\",\n        \"scope\": scope,\n        \"code_challenge\": code_challenge,\n        \"code_challenge_method\": \"S256\"\n    }\n    login_url = f\"{BASE_AUTH_URL}\u002Fauthorize?\" + \"&\".join([f\"{k}={v}\" for k, v in params.items()])\n    return RedirectResponse(url=login_url)\n\n\n@router.get(\"\u002Fconsent\")\nasync def login(request: Request, scope: str=ALL_SCOPES):\n    code_verifier = base64.urlsafe_b64encode(os.urandom(40)).decode('utf-8').rstrip('=')\n    code_challenge = base64.urlsafe_b64encode(\n        hashlib.sha256(code_verifier.encode()).digest()\n    ).decode('utf-8').rstrip('=')\n\n    request.state.session['code_verifier'] = code_verifier\n    request.state.session['scope'] = scope\n    \n    if \"offline_access\" not in scope:\n        scope += \" offline_access\"\n\n    params = {\n        \"client_id\": client_id,\n        \"response_type\": \"code\",\n        \"redirect_uri\": f\"{base_url}\u002Fapi\u002Fv1\u002Fauth\u002Foauth\u002Fcallback\",\n        \"response_mode\": \"query\",\n        \"scope\": scope,\n        \"code_challenge\": code_challenge,\n        'prompt': 'consent',\n        \"code_challenge_method\": \"S256\"\n    }\n    login_url = f\"{BASE_AUTH_URL}\u002Fauthorize?\" + \"&\".join([f\"{k}={v}\" for k, v in params.items()])\n    return RedirectResponse(url=login_url)\n\n\n@router.get(\"\u002Fcallback\")\nasync def callback(\n        request: Request,\n        code: str | None=None,\n        session_state: str | None=None,\n        error: str=None,\n        error_subcode: str=None,\n        error_description: str=None\n    ) -\u003E RedirectResponse:\n    if code is None:\n        if error == \"login_required\":\n            return RedirectResponse(url=f\"{base_url}\u002Fapi\u002Fv1\u002Fauth\u002Foauth\u002Flogin\")\n        elif error == \"consent_required\":\n            return RedirectResponse(url=f\"{base_url}\u002Fapi\u002Fv1\u002Fauth\u002Foauth\u002Fconsent\")\n        else:\n            raise HTTPException(500, f\"{error}|{error_description}\")\n    \n    code_verifier: str = request.state.session.get('code_verifier')\n    scope: str = request.state.session['scope'].split(\" \")[0]\n\n    data = await get_token_by_code(scope, code, code_verifier)\n    token = data['access_token']\n    refresh_token = data['refresh_token']\n    token_scopes = data['scope']\n\n    request.state.session[scope] = token\n    request.state.session['refresh_token'] = refresh_token\n\n    missing_scopes = {scope for scope in ALL_SCOPES.split(\" \") if scope not in token_scopes}\n    for scope in missing_scopes:\n        try:\n            data = await get_token_by_refresh_token(scope, refresh_token)\n            token = data[\"access_token\"]\n            request.state.session[scope] = token\n        except Exception as e:\n            print(e)\n        \n    request.state.session[\"scope\"] = None\n\n    return RedirectResponse(url=base_url)\n\n\nasync def get_token_by_code(\n        scope,\n        code,\n        code_verifier\n    ) -\u003E dict:\n    \"\"\"Acquire the token using refresh_token\"\"\"\n    url = f\"{BASE_AUTH_URL}\u002Ftoken\"\n    payload = {\n        \"grant_type\": \"authorization_code\",\n        \"client_id\": client_id,\n        \"client_secret\": client_secret,\n        \"scope\": scope,\n        \"code\": code,\n        \"redirect_uri\": f\"{base_url}\u002Fapi\u002Fv1\u002Fauth\u002Foauth\u002Fcallback\",\n        \"code_verifier\": code_verifier\n    }\n    response = requests.post(url, data=payload)\n    \n    response.raise_for_status()\n    data = response.json()\n\n    return data\n\n\nasync def get_token_by_refresh_token(\n        scope,\n        refresh_token\n    ) -\u003E dict:\n    \"\"\"Acquire the token using refresh_token\"\"\"\n    url = f\"{BASE_AUTH_URL}\u002Ftoken\"\n    payload = {\n        \"grant_type\": \"refresh_token\",\n        \"client_id\": client_id,\n        \"client_secret\": client_secret,\n        \"refresh_token\": refresh_token,\n        \"scope\": scope\n    }\n    response = requests.post(url, data=payload)\n    response.raise_for_status()\n    data = response.json()\n\n    return data","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"EXPLICIT","lang":"python"},"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_66":{"__typename":"Paragraph","id":"2e188b7fe0e1_66","name":"6427","type":"P","href":null,"layout":null,"metadata":null,"text":"Lets also add the changes to the frontend code to first authenticate using the silent_login endpoint:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_67":{"__typename":"Paragraph","id":"2e188b7fe0e1_67","name":"f922","type":"PRE","href":null,"layout":null,"metadata":null,"text":"function login() {\n    silentLogin();\n}\n\nfunction silentLogin() {\n    window.location.href = '\u002Fapi\u002Fv1\u002Fauth\u002Foauth\u002Fsilent_login';\n}","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"AUTO","lang":"javascript"},"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_68":{"__typename":"Paragraph","id":"2e188b7fe0e1_68","name":"f0da","type":"P","href":null,"layout":null,"metadata":null,"text":"Now when you press the authenticate button the API will:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_69":{"__typename":"Paragraph","id":"2e188b7fe0e1_69","name":"65e6","type":"OLI","href":null,"layout":null,"metadata":null,"text":"Try to log you in using existing credentials.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_70":{"__typename":"Paragraph","id":"2e188b7fe0e1_70","name":"8975","type":"OLI","href":null,"layout":null,"metadata":null,"text":"If this fails, try login you into your account.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_71":{"__typename":"Paragraph","id":"2e188b7fe0e1_71","name":"7e5d","type":"OLI","href":null,"layout":null,"metadata":null,"text":"If the consent is missing consent and login.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_72":{"__typename":"Paragraph","id":"2e188b7fe0e1_72","name":"5605","type":"P","href":null,"layout":null,"metadata":null,"text":"If both 1. and 2. fails. It will ask the user to consent to all scopes specified in the app registration:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*DDa3Wp2dqWlmrJsjXgZ7BQ.png":{"__typename":"ImageMetadata","id":"1*DDa3Wp2dqWlmrJsjXgZ7BQ.png","originalHeight":880,"originalWidth":774,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:2e188b7fe0e1_73":{"__typename":"Paragraph","id":"2e188b7fe0e1_73","name":"3b9d","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*DDa3Wp2dqWlmrJsjXgZ7BQ.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_74":{"__typename":"Paragraph","id":"2e188b7fe0e1_74","name":"6a74","type":"P","href":null,"layout":null,"metadata":null,"text":"After successfully gaining the access token and refresh_token it claims all additional scopes.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_75":{"__typename":"Paragraph","id":"2e188b7fe0e1_75","name":"2f61","type":"H3","href":null,"layout":null,"metadata":null,"text":"Conclusion","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_76":{"__typename":"Paragraph","id":"2e188b7fe0e1_76","name":"c3e5","type":"P","href":null,"layout":null,"metadata":null,"text":"Acquiring a second token for a different scope is not that hard after understanding how to get it. The hard part is to not authenticating the user multiple times and have a nice user flow. Keep in mind that the code is mostly just a Prove of Concept and should not be used in Production.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_77":{"__typename":"Paragraph","id":"2e188b7fe0e1_77","name":"f2f9","type":"P","href":null,"layout":null,"metadata":null,"text":"The project can be found on Github: https:\u002F\u002Fgithub.com\u002FFadope1\u002FMultiScopeAuth","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":36,"end":77,"href":"https:\u002F\u002Fgithub.com\u002FFadope1\u002FMultiScopeAuth","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:2e188b7fe0e1_78":{"__typename":"Paragraph","id":"2e188b7fe0e1_78","name":"2606","type":"P","href":null,"layout":null,"metadata":null,"text":"If you liked this post please clap.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Membership:5ea728329a22":{"__typename":"Membership","tier":"MEMBER","id":"5ea728329a22"},"Tag:python":{"__typename":"Tag","id":"python","displayTitle":"Python","normalizedTagSlug":"python"},"Tag:microsoft-entra-id":{"__typename":"Tag","id":"microsoft-entra-id","displayTitle":"Microsoft Entra Id","normalizedTagSlug":"microsoft-entra-id"},"Tag:oauth":{"__typename":"Tag","id":"oauth","displayTitle":"Oauth","normalizedTagSlug":"oauth"},"Tag:microsoft":{"__typename":"Tag","id":"microsoft","displayTitle":"Microsoft","normalizedTagSlug":"microsoft"},"Tag:azure":{"__typename":"Tag","id":"azure","displayTitle":"Azure","normalizedTagSlug":"azure"},"Post:74527886921c":{"__typename":"Post","id":"74527886921c","collection":null,"content({\"postMeteringOptions\":{}})":{"__typename":"PostContent","isLockedPreviewOnly":false,"bodyModel":{"__typename":"RichText","sections":[{"__typename":"Section","name":"3b18","startIndex":0,"textLayout":null,"imageLayout":null,"backgroundImage":null,"videoLayout":null,"backgroundVideo":null},{"__typename":"Section","name":"3de4","startIndex":5,"textLayout":null,"imageLayout":null,"backgroundImage":null,"videoLayout":null,"backgroundVideo":null},{"__typename":"Section","name":"d3fa","startIndex":30,"textLayout":null,"imageLayout":null,"backgroundImage":null,"videoLayout":null,"backgroundVideo":null},{"__typename":"Section","name":"c0a2","startIndex":42,"textLayout":null,"imageLayout":null,"backgroundImage":null,"videoLayout":null,"backgroundVideo":null},{"__typename":"Section","name":"56e5","startIndex":48,"textLayout":null,"imageLayout":null,"backgroundImage":null,"videoLayout":null,"backgroundVideo":null},{"__typename":"Section","name":"2805","startIndex":62,"textLayout":null,"imageLayout":null,"backgroundImage":null,"videoLayout":null,"backgroundVideo":null}],"paragraphs":[{"__ref":"Paragraph:2e188b7fe0e1_0"},{"__ref":"Paragraph:2e188b7fe0e1_1"},{"__ref":"Paragraph:2e188b7fe0e1_2"},{"__ref":"Paragraph:2e188b7fe0e1_3"},{"__ref":"Paragraph:2e188b7fe0e1_4"},{"__ref":"Paragraph:2e188b7fe0e1_5"},{"__ref":"Paragraph:2e188b7fe0e1_6"},{"__ref":"Paragraph:2e188b7fe0e1_7"},{"__ref":"Paragraph:2e188b7fe0e1_8"},{"__ref":"Paragraph:2e188b7fe0e1_9"},{"__ref":"Paragraph:2e188b7fe0e1_10"},{"__ref":"Paragraph:2e188b7fe0e1_11"},{"__ref":"Paragraph:2e188b7fe0e1_12"},{"__ref":"Paragraph:2e188b7fe0e1_13"},{"__ref":"Paragraph:2e188b7fe0e1_14"},{"__ref":"Paragraph:2e188b7fe0e1_15"},{"__ref":"Paragraph:2e188b7fe0e1_16"},{"__ref":"Paragraph:2e188b7fe0e1_17"},{"__ref":"Paragraph:2e188b7fe0e1_18"},{"__ref":"Paragraph:2e188b7fe0e1_19"},{"__ref":"Paragraph:2e188b7fe0e1_20"},{"__ref":"Paragraph:2e188b7fe0e1_21"},{"__ref":"Paragraph:2e188b7fe0e1_22"},{"__ref":"Paragraph:2e188b7fe0e1_23"},{"__ref":"Paragraph:2e188b7fe0e1_24"},{"__ref":"Paragraph:2e188b7fe0e1_25"},{"__ref":"Paragraph:2e188b7fe0e1_26"},{"__ref":"Paragraph:2e188b7fe0e1_27"},{"__ref":"Paragraph:2e188b7fe0e1_28"},{"__ref":"Paragraph:2e188b7fe0e1_29"},{"__ref":"Paragraph:2e188b7fe0e1_30"},{"__ref":"Paragraph:2e188b7fe0e1_31"},{"__ref":"Paragraph:2e188b7fe0e1_32"},{"__ref":"Paragraph:2e188b7fe0e1_33"},{"__ref":"Paragraph:2e188b7fe0e1_34"},{"__ref":"Paragraph:2e188b7fe0e1_35"},{"__ref":"Paragraph:2e188b7fe0e1_36"},{"__ref":"Paragraph:2e188b7fe0e1_37"},{"__ref":"Paragraph:2e188b7fe0e1_38"},{"__ref":"Paragraph:2e188b7fe0e1_39"},{"__ref":"Paragraph:2e188b7fe0e1_40"},{"__ref":"Paragraph:2e188b7fe0e1_41"},{"__ref":"Paragraph:2e188b7fe0e1_42"},{"__ref":"Paragraph:2e188b7fe0e1_43"},{"__ref":"Paragraph:2e188b7fe0e1_44"},{"__ref":"Paragraph:2e188b7fe0e1_45"},{"__ref":"Paragraph:2e188b7fe0e1_46"},{"__ref":"Paragraph:2e188b7fe0e1_47"},{"__ref":"Paragraph:2e188b7fe0e1_48"},{"__ref":"Paragraph:2e188b7fe0e1_49"},{"__ref":"Paragraph:2e188b7fe0e1_50"},{"__ref":"Paragraph:2e188b7fe0e1_51"},{"__ref":"Paragraph:2e188b7fe0e1_52"},{"__ref":"Paragraph:2e188b7fe0e1_53"},{"__ref":"Paragraph:2e188b7fe0e1_54"},{"__ref":"Paragraph:2e188b7fe0e1_55"},{"__ref":"Paragraph:2e188b7fe0e1_56"},{"__ref":"Paragraph:2e188b7fe0e1_57"},{"__ref":"Paragraph:2e188b7fe0e1_58"},{"__ref":"Paragraph:2e188b7fe0e1_59"},{"__ref":"Paragraph:2e188b7fe0e1_60"},{"__ref":"Paragraph:2e188b7fe0e1_61"},{"__ref":"Paragraph:2e188b7fe0e1_62"},{"__ref":"Paragraph:2e188b7fe0e1_63"},{"__ref":"Paragraph:2e188b7fe0e1_64"},{"__ref":"Paragraph:2e188b7fe0e1_65"},{"__ref":"Paragraph:2e188b7fe0e1_66"},{"__ref":"Paragraph:2e188b7fe0e1_67"},{"__ref":"Paragraph:2e188b7fe0e1_68"},{"__ref":"Paragraph:2e188b7fe0e1_69"},{"__ref":"Paragraph:2e188b7fe0e1_70"},{"__ref":"Paragraph:2e188b7fe0e1_71"},{"__ref":"Paragraph:2e188b7fe0e1_72"},{"__ref":"Paragraph:2e188b7fe0e1_73"},{"__ref":"Paragraph:2e188b7fe0e1_74"},{"__ref":"Paragraph:2e188b7fe0e1_75"},{"__ref":"Paragraph:2e188b7fe0e1_76"},{"__ref":"Paragraph:2e188b7fe0e1_77"},{"__ref":"Paragraph:2e188b7fe0e1_78"}]},"validatedShareKey":"","shareKeyCreator":null},"creator":{"__ref":"User:ab00f83c5330"},"inResponseToEntityType":null,"isLocked":false,"isMarkedPaywallOnly":false,"lockedSource":"LOCKED_POST_SOURCE_NONE","mediumUrl":"https:\u002F\u002Fmedium.com\u002F@fadop3\u002Fnavigating-the-complexity-of-acquiring-multiple-resource-group-scopes-in-oauth-74527886921c","primaryTopic":null,"topics":[{"__typename":"Topic","slug":"programming"}],"isPublished":true,"latestPublishedVersion":"2e188b7fe0e1","visibility":"PUBLIC","postResponses":{"__typename":"PostResponses","count":0},"createdAt":1702675510205,"firstPublishedAt":1705276480242,"latestPublishedAt":1705276480242,"clapCount":50,"allowResponses":true,"isLimitedState":false,"title":"Navigating the Complexity of Acquiring Multiple Resource Group Scopes in OAuth","isSeries":false,"sequence":null,"uniqueSlug":"navigating-the-complexity-of-acquiring-multiple-resource-group-scopes-in-oauth-74527886921c","socialTitle":"","socialDek":"","noIndex":null,"canonicalUrl":"","metaDescription":"","readingTime":9.14056603773585,"previewContent":{"__typename":"PreviewContent","subtitle":"Multi scope token authentication in Microsoft Entra ID"},"previewImage":{"__ref":"ImageMetadata:1*ytetQ6n7dB1Sm8e_wbcPBw.png"},"isShortform":false,"seoTitle":"Multiscope Authentication in oauth. Using entraID","updatedAt":1705278532943,"shortformType":"SHORTFORM_TYPE_LINK","seoDescription":"Using oauth2 to acquire multiple Ressource group Scopes.","isSuspended":false,"license":"ALL_RIGHTS_RESERVED","tags":[{"__ref":"Tag:python"},{"__ref":"Tag:microsoft-entra-id"},{"__ref":"Tag:oauth"},{"__ref":"Tag:microsoft"},{"__ref":"Tag:azure"}],"pendingCollection":null,"statusForCollection":null,"detectedLanguage":"en","wordCount":2144,"layerCake":0}}</script><script>window.__MIDDLEWARE_STATE__={"session":{"xsrf":""},"cache":{"cacheStatus":"HIT"}}</script><script src="https://cdn-client.medium.com/lite/static/js/manifest.716896ab.js"></script><script src="https://cdn-client.medium.com/lite/static/js/3057.5e22bbb0.js"></script><script src="https://cdn-client.medium.com/lite/static/js/main.28d33862.js"></script><script src="https://cdn-client.medium.com/lite/static/js/instrumentation.7c58a71f.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/reporting.2021fe63.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/4398.db4d4378.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/7883.0e445e04.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/6733.1d85727b.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/4711.043615ac.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/8695.d81be414.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/4341.09a484a0.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/2522.c9ccdc98.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/5203.e7a22052.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/3486.68d9a40d.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/8084.ff129ede.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/6616.ad837199.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/1711.b70f1a35.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/5459.80a6ee18.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/9114.49b6b911.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/6804.53e6dec4.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/9174.b1cc3539.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/4129.ee8ae2c8.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/2295.30dff0b0.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/2550.9fcdbe78.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/8580.feeb2549.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/8883.c8b03d13.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/4078.da7800a7.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/2539.f55454a0.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/9408.1c6d46ac.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/9150.42fafb2e.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/5005.b5d4a37c.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/2393.fcf95ce7.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/7600.4d7a7595.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/PostPage.MainContent.e7341618.chunk.js"></script><script>window.main();</script><script defer src="https://static.cloudflareinsights.com/beacon.min.js/v84a3a4012de94ce1a686ba8c167c359c1696973893317" integrity="sha512-euoFGowhlaLqXsPWQ48qSkBSCFs3DPRyiwVu3FjR96cMPx+Fr+gpWRhIafcHwqwCqWS42RZhIudOvEI+Ckf6MA==" data-cf-beacon='{"rayId":"85360287afec19af","b":1,"version":"2024.2.0","token":"0b5f665943484354a59c39c6833f7078"}' crossorigin="anonymous"></script>
</body></html>